<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="Dconf 2017で出てきたコマンドラインスイッチ-vcg-astについて書き残しておく。 これはgccでいう-Eオプションのようなもので、これはいろ"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.a46209b7292a5337cb1ba441dd38238fbe3cc498d46e0bd08c757deccdc8f28f.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang 処理後の結果を見られるdmdのスイッチ -vcg-ast - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2017/05/vcg-ast/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#dlang 処理後の結果を見られるdmdのスイッチ -vcg-ast - Kotet's Personal Blog"><meta name=og:description content="Dconf 2017で出てきたコマンドラインスイッチ-vcg-astについて書き残しておく。 これはgccでいう-Eオプションのようなもので、これはいろ"><meta name=twitter:image content=https://blog.kotet.jpimg/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2017/05/vcg-ast/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.53"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><a href=/about>ABOUT</a></li><li><a href=/products>PRODUCTS</a></li><li><a href=/tags>TAGS</a></li><li><a href=/index.xml>FEED</a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
処理後の結果を見られるdmdのスイッチ -vcg-ast</h2><p><time>2017-05-08</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p><div style="border:.5em solid gold;padding:1em;margin-bottom:1em"><p style=font-weight:700;margin:0>これは1年以上前の記事です</p><p style=margin:0>ここに書かれている情報、見解は現在のものとは異なっている場合があります。</p></div><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#使ってみる>使ってみる</a><ul><li><a href=#app-d><code>app.d</code></a></li><li><a href=#app-d-cg><code>app.d.cg</code></a></li></ul></li><li><a href=#dubで使う>dubで使う</a><ul><li><a href=#dub-json><code>dub.json</code></a></li><li><a href=#source-app-d><code>source/app.d</code></a></li><li><a href=#source-app-d-cg><code>source/app.d.cg</code></a></li></ul></li><li><a href=#関連リンク>関連リンク</a></li></ul></li></ul></li></ul></nav></aside></header><article><p><a href=http://dconf.org/2017/talks/koch.html>Dconf 2017で出てきた</a>コマンドラインスイッチ<code>-vcg-ast</code>について書き残しておく。
これはgccでいう<code>-E</code>オプションのようなもので、これはいろいろな&rdquo;semantic steps&rdquo; <sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup>
がすべて終了したあとのASTを読めるかたちに書きだすオプションである。</p><iframe width=560 height=315 src="https://www.youtube-nocookie.com/embed/crHnumzsLUs?rel=0" frameborder=0 allow="autoplay; encrypted-media" allowfullscreen></iframe><p><code>-vcg-ast</code>が使われた動画。
使用箇所付近(25:00)から再生が始まる。</p><h3 id=使ってみる>使ってみる</h3><h4 id=app-d><code>app.d</code></h4><pre><code class=language-d>void main()
{
	import std.stdio : writeln;

	static immutable table = () {
		import std.range : iota, array;
		import std.algorithm : map;
		import std.math : sqrt;

		return 10.iota.map!((real n) =&gt; n.sqrt()).array;
	}();
	alias T = table;
	mixin(&quot;writeln(T);&quot;);
}
</code></pre><p>ここで<code>$ dmd app.d -vcg-ast</code>すると、<code>app.d.cg</code>というファイルが生成される。
中を見たら7912行もあった。</p><h4 id=app-d-cg><code>app.d.cg</code></h4><pre><code class=language-d>import object;
void main()
{
	import std.stdio : writeln;
	static immutable immutable(real[]) table = [0.00000L, 1.00000L, 1.41421L, 1.73205L, 2.00000L, 2.23607L, 2.44949L, 2.64575L, 2.82843L, 3.00000L];
	alias T = static immutable immutable(real[]) table = [0.00000L, 1.00000L, 1.41421L, 1.73205L, 2.00000L, 2.23607L, 2.44949L, 2.64575L, 2.82843L, 3.00000L];
	;
	writeln(table);
	return 0;
}
CommonType!(int, int)
alias CommonType = int;
CommonType!int
alias CommonType = int;
isFloatingPoint!int
enum bool isFloatingPoint = false;
Unqual!int
alias Unqual = int;
// 以下略
</code></pre><p>関数リテラルはCTFEの結果である配列になり、文字列mixinは普通のコードになり、さらにaliasも展開されている。
やたら行数が大きいのは自動的にimportされた<code>object</code>のせいだろう。
コードがコンパイラによってどのように展開されるかを知ることができてためになるし、なんだか見てて楽しい。</p><h3 id=dubで使う>dubで使う</h3><p><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr>とりあえずdub使ってる人は、dub.jsonの場合、<br>&quot;configuration&quot;: [<br>{ &quot;name&quot;: &quot;ast&quot;, &quot;dflag&quot;: [&quot;-vcg-ast&quot;] }<br>]<br>と書き足すなどしてビルドすると一発の模様です。</p>&mdash; lempiji@思秋期 (@lempiji) <a href=https://twitter.com/lempiji/status/860459096897576960>2017年5月5日</a></blockquote><script async src=//platform.twitter.com/widgets.js></script></p><h4 id=dub-json><code>dub.json</code></h4><pre><code class=language-json>{
	&quot;name&quot;: &quot;test&quot;,
	&quot;authors&quot;: [
		&quot;kotet&quot;
	],
	&quot;description&quot;: &quot;A minimal D application.&quot;,
	&quot;copyright&quot;: &quot;Copyright © 2017, kotet&quot;,
	&quot;license&quot;: &quot;proprietary&quot;,
	&quot;dependencies&quot;: {
		&quot;progress&quot;: &quot;*&quot;
	},
	&quot;targetType&quot;: &quot;executable&quot;,
	&quot;configurations&quot;: [
		{
			&quot;name&quot;: &quot;default&quot;
		},
		{
			&quot;name&quot;: &quot;ast&quot;,
			&quot;dflags&quot;: [
				&quot;-vcg-ast&quot;
			]
		}
	]
}
</code></pre><h4 id=source-app-d><code>source/app.d</code></h4><pre><code class=language-d>void main()
{
	import std.stdio : writeln;
	import std.range : iota;
	import progress.bar : Bar;

	auto b = new Bar();
	foreach (n; b.iter(10.iota))
	{
	}
	mixin(&quot;writeln(b);&quot;);
}
</code></pre><p><code>$ dub build -c ast</code>すると.d.cgファイルが出力される。</p><h4 id=source-app-d-cg><code>source/app.d.cg</code></h4><pre><code class=language-d>import object;
void main()
{
	import std.stdio : writeln;
	import std.range : iota;
	import progress.bar : Bar;
	Bar b = new Bar;
	{
		Generator!int __r3001 = b.iter(iota(10));
		for (; !__r3001.empty(); __r3001.popFront())
		{
			int n = __r3001.front();
		}
	}
	writeln(b);
	return 0;
}
// 以下略
</code></pre><p><code>foreach</code>が<code>for</code>に展開されている。
たのしい。</p><h3 id=関連リンク>関連リンク</h3><ul><li><a href=http://forum.dlang.org/thread/oendp1$ct4$1@digitalmars.com>-vcg-ast dmd command line switch - D Programming Language Discussion Forum</a></li><li><a href="https://www.youtube.com/playlist?list=PL3jwVPmk_PRxo23yyoc0Ip_cP3-rCm7eB">DConf 2017 - YouTube</a></li></ul><div class=footnotes><hr><ol><li id=fn:1><a href=https://github.com/dlang/dmd/pull/6556>vcg-ast by UplinkCoder · Pull Request #6556 · dlang/dmd</a>
<a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li></ol></div></article><footer><h2><a href=/tags/dlang>#dlang</a>
処理後の結果を見られるdmdのスイッチ -vcg-ast</h2><p><time>2017-05-08</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>