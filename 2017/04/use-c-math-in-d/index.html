<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="前回の続き。 今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、 ということでcore.stdc.mathを使わずにD言語のアプ"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.a46209b7292a5337cb1ba441dd38238fbe3cc498d46e0bd08c757deccdc8f28f.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang dubで自力でCのsqrt()を呼び出す - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2017/04/use-c-math-in-d/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#dlang dubで自力でCのsqrt()を呼び出す - Kotet's Personal Blog"><meta name=og:description content="前回の続き。 今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、 ということでcore.stdc.mathを使わずにD言語のアプ"><meta name=twitter:image content=https://blog.kotet.jp/assets/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2017/04/use-c-math-in-d/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.52"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><a href=/about>ABOUT</a></li><li><a href=/products>PRODUCTS</a></li><li><a href=/tags>TAGS</a></li><li><a href=/index.xml>FEED</a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
dubで自力でCのsqrt()を呼び出す</h2><p><time>2017-04-29</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p><div style="border:.5em solid gold;padding:1em;margin-bottom:1em"><p style=font-weight:700;margin:0>これは1年以上前の記事です</p><p style=margin:0>ここに書かれている情報、見解は現在のものとは異なっている場合があります。</p></div><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#1-dub-init>1 - <code>dub init</code></a></li><li><a href=#2-関数の宣言を探す>2 - 関数の宣言を探す</a></li><li><a href=#3-プリプロセス>3 - プリプロセス</a></li><li><a href=#4-関数の宣言>4 - 関数の宣言</a><ul><li><a href=#source-math-d-new-file><code>source/math.d</code> (New file)</a></li></ul></li><li><a href=#5-使う>5 - 使う</a><ul><li><a href=#source-app-d><code>source/app.d</code></a></li></ul></li><li><a href=#6-dub-build>6 - <code>dub build</code></a></li><li><a href=#7-完成>7 - 完成</a></li><li><a href=#追記>追記</a></li></ul></li></ul></li></ul></nav></aside></header><article><p><a href=/2017/04/28/use-c-stdio-in-d.html>前回</a>の続き。
今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、
ということで<code>core.stdc.math</code>を使わずにD言語のアプリケーションからC言語の<code>sqrt</code>を呼び出してみる。
自分みたいな初心者のための基礎的な記事を量産することを目標にしているので、細かい手順をできるだけ詳細に具体的に書いていきたい。</p><h3 id=1-dub-init>1 - <code>dub init</code></h3><p>前回と同じ。</p><pre><code class=language-console>$ tree
.
├── dub.json
└── source
    └── app.d

1 directory, 2 files
</code></pre><h3 id=2-関数の宣言を探す>2 - 関数の宣言を探す</h3><p><code>/usr/include/math.h</code>を読んでみる。</p><pre><code class=language-console>$ cat /usr/include/math.h | grep sqrt
# define M_2_SQRTPI     1.12837916709551257390  /* 2/sqrt(pi) */
# define M_SQRT2        1.41421356237309504880  /* sqrt(2) */
# define M_SQRT1_2      0.70710678118654752440  /* 1/sqrt(2) */
# define M_2_SQRTPIl    1.128379167095512573896158903121545172L /* 2/sqrt(pi) */
# define M_SQRT2l       1.414213562373095048801688724209698079L /* sqrt(2) */
# define M_SQRT1_2l     0.707106781186547524400844362104849039L /* 1/sqrt(2) */
</code></pre><p>どうも宣言っぽいのは見つからない。</p><h3 id=3-プリプロセス>3 - プリプロセス</h3><p>ヘッダファイル内のマクロとかを全部展開する必要がある。
<code>gcc -E</code>でコンパイルをせずにプリプロセスだけを行える。</p><pre><code class=language-console>$ cat /usr/include/math.h | wc -l
537
$ gcc -E /usr/include/math.h | wc -l
5314
</code></pre><p>行数が10倍ほどになっている……</p><p>lessで開いて検索したところ、<code>sqrt</code>の宣言らしきものを見つけた。</p><pre><code class=language-c># 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot;
extern double
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot; 3 4
sqrt (
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot;
double
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot; 3 4
__x) __attribute__ ((__nothrow__ , __leaf__))
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot;
; extern double __sqrt
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot; 3 4
(
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot;
double
# 156 &quot;/usr/include/x86_64-linux-gnu/bits/mathcalls.h&quot; 3 4
__x) __attribute__ ((__nothrow__ , __leaf__));
</code></pre><p>超絶読みにくいが、整理するとこんなことが書いてある。</p><pre><code class=language-c>extern double sqrt ( double __x) __attribute__ ((__nothrow__ , __leaf__));
extern double __sqrt ( double __x) __attribute__ ((__nothrow__ , __leaf__));
</code></pre><h3 id=4-関数の宣言>4 - 関数の宣言</h3><p>というわけで前回と同じように<code>sqrt</code>だけを宣言する。</p><h4 id=source-math-d-new-file><code>source/math.d</code> (New file)</h4><pre><code class=language-d>extern (C) double sqrt(double __x);
</code></pre><h3 id=5-使う>5 - 使う</h3><h4 id=source-app-d><code>source/app.d</code></h4><pre><code class=language-d>import math;
import std.stdio;

void main()
{
	writeln(&quot;sqrt( 2 ) == &quot;, sqrt(2));
}
</code></pre><h3 id=6-dub-build>6 - <code>dub build</code></h3><p>リンカオプションを渡してやる必要があると思ったがそんなことはなかったぜ!
今回はリンクするライブラリを指定する回になる予定だったのだが、結果的にプリプロセスをする回になった。</p><h3 id=7-完成>7 - 完成</h3><pre><code class=language-console>$ ./test
sqrt( 2 ) == 1.41421
</code></pre><hr><h3 id=追記>追記</h3><p><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr><a href=https://twitter.com/kotetttt>@kotetttt</a> <a href=https://t.co/2CWXBfFs2k>https://t.co/2CWXBfFs2k</a><br>なんかちょっと解説みたいなの書いてみるか〜とかしたら怪文書になってしまいました。。蛇足はほんとに蛇足なので読まないでもぜんぜんいいやつです。</p>&mdash; ありがとうけものフレンズ (@shitsyndrome) <a href=https://twitter.com/shitsyndrome/status/859101734173458433>2017年5月1日</a></blockquote><script async src=//platform.twitter.com/widgets.js></script></p><hr><p><a href=/2017/05/03/use-c-sha256-in-d.html>次回:OpenSSLを使う</a></p></article><footer><h2><a href=/tags/dlang>#dlang</a>
dubで自力でCのsqrt()を呼び出す</h2><p><time>2017-04-29</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>