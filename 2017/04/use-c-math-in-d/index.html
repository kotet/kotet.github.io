<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>#dlang dubで自力でCのsqrt()を呼び出す - Kotet&#39;s Personal Blog </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/main.css" />
    <link rel="canonical" href="https://blog.kotet.jp/2017/04/use-c-math-in-d/" />
    <script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-88180620-1');
    </script>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8443812672116269",
        enable_page_level_ads: true
    });
    </script>
    <link rel="icon" href="/favicon.ico">
    <meta name="twitter:card" content="summary" />
<meta name="og:title" content="#dlang dubで自力でCのsqrt()を呼び出す - Kotet&#39;s Personal Blog" />
<meta name="og:description" content=" 前回の続き。 今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、 ということでcore.stdc.mathを使わずにD言語のアプ  " />

<meta name="twitter:image" content="https://blog.kotet.jp/assets/logo.png" />

<meta name="twitter:url" content="https://blog.kotet.jp/2017/04/use-c-math-in-d/" />
<meta name="twitter:site" content="@kotetttt" />
<meta name="twitter:creator" content="@kotetttt" />
    <meta name="generator" content="Hugo 0.49-DEV" />
    
<meta name="description" content=" 前回の続き。 今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、 ということでcore.stdc.mathを使わずにD言語のアプ ">
<style>
    main {
        width: 800px;
        max-width: 100%;
        margin: 0 auto;
    }

    main > header {
        margin: 1em;
    }

    main > article {
        margin: 1em;
    }

    main > footer {
        color: var(--textgray);
        border-top: var(--border);
        padding: 1em;
    }

    main > footer a {
        color: var(--textgray);
    }

    main > footer h2 {
        display: inline;
        font-size: 1em;
    }

    main > footer p {
        display: inline;
        margin-left: 1em;
    }

    #TableOfContents>ul {
         
        padding: 0;
    }

    #TableOfContents>ul>li>ul {
         
        padding: 0;
    }

    #TableOfContents li {
        list-style: none;
    }

    #TableOfContents>ul>li>ul>li>ul li {
        list-style-type: initial;
    }

    aside {
        padding: .5em 1em;
        background: #EEE;
    }
</style>
<script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>

</head>

<body>
    <header class="site">
        <h1><a href="/">Kotet&#39;s Personal Blog</a></h1>
        <nav>
            <ul>
                <li><a href="/about">ABOUT</a></li>
                <li><a href="/products">PRODUCTS</a></li>
                <li><a href="/tags">TAGS</a></li>
                <li><a href="/index.xml">FEED</a></li>
                
            </ul>
        </nav>
    </header>
    <main>
        
<header>
    <h2>
        
        <a href="/tags/dlang">#dlang</a>
        
        dubで自力でCのsqrt()を呼び出す
    </h2>
    <p>
        <time>2017-04-29</time>
         <a href="/tags/dlang">#dlang</a>  <a href="/tags/tech">#tech</a> 
    </p>
    <aside>
    <p>Table of Contents</p>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#1-dub-init">1 - <code>dub init</code></a></li>
<li><a href="#2-関数の宣言を探す">2 - 関数の宣言を探す</a></li>
<li><a href="#3-プリプロセス">3 - プリプロセス</a></li>
<li><a href="#4-関数の宣言">4 - 関数の宣言</a>
<ul>
<li><a href="#source-math-d-new-file"><code>source/math.d</code> (New file)</a></li>
</ul></li>
<li><a href="#5-使う">5 - 使う</a>
<ul>
<li><a href="#source-app-d"><code>source/app.d</code></a></li>
</ul></li>
<li><a href="#6-dub-build">6 - <code>dub build</code></a></li>
<li><a href="#7-完成">7 - 完成</a></li>
<li><a href="#追記">追記</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</aside>
</header>
<article>

<p><a href="/2017/04/28/use-c-stdio-in-d.html">前回</a>の続き。
今度はヘッダファイルを読むのにプリプロセスの必要なものを使いたい、
ということで<code>core.stdc.math</code>を使わずにD言語のアプリケーションからC言語の<code>sqrt</code>を呼び出してみる。
自分みたいな初心者のための基礎的な記事を量産することを目標にしているので、細かい手順をできるだけ詳細に具体的に書いていきたい。</p>

<h3 id="1-dub-init">1 - <code>dub init</code></h3>

<p>前回と同じ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ tree
.
├── dub.json
└── source
    └── app.d

1 directory, 2 files</code></pre></div>
<h3 id="2-関数の宣言を探す">2 - 関数の宣言を探す</h3>

<p><code>/usr/include/math.h</code>を読んでみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ cat /usr/include/math.h | grep sqrt
# define M_2_SQRTPI     1.12837916709551257390  /* 2/sqrt(pi) */
# define M_SQRT2        1.41421356237309504880  /* sqrt(2) */
# define M_SQRT1_2      0.70710678118654752440  /* 1/sqrt(2) */
# define M_2_SQRTPIl    1.128379167095512573896158903121545172L /* 2/sqrt(pi) */
# define M_SQRT2l       1.414213562373095048801688724209698079L /* sqrt(2) */
# define M_SQRT1_2l     0.707106781186547524400844362104849039L /* 1/sqrt(2) */</code></pre></div>
<p>どうも宣言っぽいのは見つからない。</p>

<h3 id="3-プリプロセス">3 - プリプロセス</h3>

<p>ヘッダファイル内のマクロとかを全部展開する必要がある。
<code>gcc -E</code>でコンパイルをせずにプリプロセスだけを行える。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ cat /usr/include/math.h | wc -l
537
$ gcc -E /usr/include/math.h | wc -l
5314</code></pre></div>
<p>行数が10倍ほどになっている……</p>

<p>lessで開いて検索したところ、<code>sqrt</code>の宣言らしきものを見つけた。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">double</span>
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34; 3 4</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>sqrt (
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span>
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34; 3 4</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>__x) __attribute__ ((__nothrow__ , __leaf__))
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>; <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">double</span> __sqrt
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34; 3 4</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>(
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">double</span>
<span style="color:#75715e"># 156 &#34;/usr/include</span><span style="color:#75715e">/x86_64-linux-gnu/bits/mathcalls.h&#34; 3 4</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>__x) __attribute__ ((__nothrow__ , __leaf__));</code></pre></div>
<p>超絶読みにくいが、整理するとこんなことが書いてある。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">sqrt</span> ( <span style="color:#66d9ef">double</span> __x) __attribute__ ((__nothrow__ , __leaf__));
<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">__sqrt</span> ( <span style="color:#66d9ef">double</span> __x) __attribute__ ((__nothrow__ , __leaf__));</code></pre></div>
<h3 id="4-関数の宣言">4 - 関数の宣言</h3>

<p>というわけで前回と同じように<code>sqrt</code>だけを宣言する。</p>

<h4 id="source-math-d-new-file"><code>source/math.d</code> (New file)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-d" data-lang="d">extern (C) double sqrt(double __x);</code></pre></div>
<h3 id="5-使う">5 - 使う</h3>

<h4 id="source-app-d"><code>source/app.d</code></h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-d" data-lang="d">import math;
import std.stdio;

void main()
{
	writeln(&#34;sqrt( 2 ) == &#34;, sqrt(2));
}</code></pre></div>
<h3 id="6-dub-build">6 - <code>dub build</code></h3>

<p>リンカオプションを渡してやる必要があると思ったがそんなことはなかったぜ!
今回はリンクするライブラリを指定する回になる予定だったのだが、結果的にプリプロセスをする回になった。</p>

<h3 id="7-完成">7 - 完成</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ ./test
sqrt( 2 ) == 1.41421</code></pre></div>
<hr />

<h3 id="追記">追記</h3>

<p><blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr"><a href="https://twitter.com/kotetttt">@kotetttt</a> <a href="https://t.co/2CWXBfFs2k">https://t.co/2CWXBfFs2k</a><br>なんかちょっと解説みたいなの書いてみるか〜とかしたら怪文書になってしまいました。。蛇足はほんとに蛇足なので読まないでもぜんぜんいいやつです。</p>&mdash; ありがとうけものフレンズ (@shitsyndrome) <a href="https://twitter.com/shitsyndrome/status/859101734173458433">2017年5月1日</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<hr />

<p><a href="/2017/05/03/use-c-sha256-in-d.html">次回:OpenSSLを使う</a></p>
</article>
<footer>
    <h2>
        
        <a href="/tags/dlang">#dlang</a>
        
        dubで自力でCのsqrt()を呼び出す
    </h2>
    <p>
        <time>2017-04-29</time>
         <a href="/tags/dlang">#dlang</a>  <a href="/tags/tech">#tech</a> 
    </p>
</footer>

        <div class="ad-wrapper"></div>
    </main>
    <footer class="site">
</footer>
</body>

</html>