<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content='‪"Dには、こんにち使用されている多くの言語と同じように、すぐに使えるガベージコレクタがあります。‬‪GCのことを心配せずにかけて、それを最大限活用できるタイプのソフトウェアが多くあります。‬しかしGCは不利な点を持ち、ガベージコレクションが望ましくないシナリオがたしかにあります。‬"'><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.02c91f0bdf54d569f6c715f0a345bf32b55cd4d3ac11e0b98fec7ad1e614c151.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang 死神を恐れないで - GCについて知る【翻訳】 - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2017/04/dont-fear-the-reaper/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#dlang 死神を恐れないで - GCについて知る【翻訳】 - Kotet's Personal Blog"><meta name=og:description content='‪"Dには、こんにち使用されている多くの言語と同じように、すぐに使えるガベージコレクタがあります。‬‪GCのことを心配せずにかけて、それを最大限活用できるタイプのソフトウェアが多くあります。‬しかしGCは不利な点を持ち、ガベージコレクションが望ましくないシナリオがたしかにあります。‬"'><meta name=twitter:image content=https://blog.kotet.jp/img/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2017/04/dont-fear-the-reaper/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.55.2"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><span class=text-up>ABOUT</span><a href=/about title=about><svg width="22" height="22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="info" transform="translate(-1.000000, -1.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M12 23C5.92486775 23 1 18.0751322 1 12 1 5.92486775 5.92486775 1 12 1 18.0751322 1 23 5.92486775 23 12 23 18.0751322 18.0751322 23 12 23zm0-2C16.9705627 21 21 16.9705627 21 12 21 7.02943725 16.9705627 3 12 3 7.02943725 3 3 7.02943725 3 12 3 16.9705627 7.02943725 21 12 21zM13.0036109 13.9983464H14.0029544v2h-4v-2h1v-2h-1V9.99834639h3.0006565V13.9983464zM12.0003283 8.99834639C11.4478622 8.99834639 11 8.55063114 11 7.99834639 11 7.44606164 11.4478622 6.99834639 12.0003283 6.99834639 12.5527943 6.99834639 13.0006565 7.44606164 13.0006565 7.99834639c0 .5522847500000001-.44786219999999943 1-1.0003282000000002 1z" id="Oval-17" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>DOWNLOAD</span><a href=/products title=download><svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="download" transform="translate(-2.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M22 16v4C22 21.1045695 21.1045695 22 20 22H4C2.8954305 22 2 21.1045695 2 20V16H4v4H20V16h2zm-9-3.4142136L16.2928932 9.29289322 17.7071068 10.7071068 12 16.4142136 6.29289322 10.7071068 7.70710678 9.29289322 11 12.5857864V2h2V12.5857864z" id="Combined-Shape" fill="#000"/></g></g></svg></a></li><li><span class=text-up>TAG</span><a href=/tags title=tag><svg width="22" height="14" viewBox="0 0 22 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="tag" transform="translate(-1.000000, -5.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M6.53518376 5H21C22.1045695 5 23 5.8954305 23 7V17C23 18.1045695 22.1045695 19 21 19H6.53518376C5.86647738 19 5.24201473 18.6657977 4.87108317 18.1094004L1.16794971 12.5547002C.944016765 12.2188008.944016765 11.7811992 1.16794971 11.4452998L4.87108317 5.89059961C5.24201473 5.33420227 5.86647738 5 6.53518376 5zM3.20185043 12l3.33333333 5H21V7H6.53518376L3.20185043 12zM7 13C6.44771525 13 6 12.5522847 6 12 6 11.4477153 6.44771525 11 7 11 7.55228475 11 8 11.4477153 8 12 8 12.5522847 7.55228475 13 7 13z" id="Rectangle-29" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>PODCAST</span><a href=https://podcast.kotet.jp title=podcast><svg width="22" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="broadcasting" transform="translate(-1.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M9.38742589 20 8.72075922 22H6.61257411L9.89881747 12.1412699C9.34410225 11.5968755 9 10.8386225 9 10 9 8.34314575 10.3431458 7 12 7 13.6568542 7 15 8.34314575 15 10 15 10.8386225 14.6558977 11.5968755 14.1011825 12.1412699L17.3874259 22H15.2792408L14.6125741 20H9.38742589zM10.7207592 16 10.0540926 18H13.9459074L13.2792408 16H10.7207592zM11.3874259 14H12.6125741L12.2750928 12.987556C12.1844984 12.9957918 12.0927406 13 12 13 11.9072594 13 11.8155016 12.9957918 11.7249072 12.987556L11.3874259 14zM12 11C12.5522847 11 13 10.5522847 13 10 13 9.44771525 12.5522847 9 12 9 11.4477153 9 11 9.44771525 11 10 11 10.5522847 11.4477153 11 12 11zm8.108743-8.43301443C21.9041909 4.52460368 23 7.13433188 23 10 23 12.8656681 21.9041909 15.4753963 20.108743 17.4330144L18.6344261 16.0815573C20.103429 14.4798697 21 12.3446376 21 10 21 7.65536245 20.103429 5.52013028 18.6344261 3.91844274L20.108743 2.56698557zM17.1601092 5.26989991C18.302667 6.51565689 19 8.17639301 19 10 19 11.823607 18.302667 13.4843431 17.1601092 14.7301001L15.6857923 13.3786429C16.501905 12.4888165 17 11.3025764 17 10 17 8.69742358 16.501905 7.51118349 15.6857923 6.62135708L17.1601092 5.26989991zM3.89125699 2.56665655 5.3655739 3.91811372C3.89657104 5.51980126 3 7.65503343 3 9.99967098 3 12.3443085 3.89657104 14.4795407 5.3655739 16.0812282L3.89125699 17.4326854C2.09580905 15.4750673 1 12.8653391 1 9.99967098 1 7.13400286 2.09580905 4.52427466 3.89125699 2.56665655zM6.83989081 5.26957089 8.31420772 6.62102806C7.49809502 7.51085447 7 8.69709456 7 9.99967098 7 11.3022474 7.49809502 12.4884875 8.31420772 13.3783139L6.83989081 14.7297711C5.69733303 13.4840141 5 11.823278 5 9.99967098 5 8.17606399 5.69733303 6.51532787 6.83989081 5.26957089z" id="Combined-Shape" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-up>FEED</span><a href=/index.xml title=feed><svg width="22" height="18" viewBox="6 8 .5 10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs><path d="M1 21V19C2.1045695 19 3 19.8954305 3 21H1zm6 0H5C5 18.790861 3.209139 17 1 17V15C4.3137085 15 7 17.6862915 7 21zm4 0H9C9 16.581722 5.418278 13 1 13V11C6.5228475 11 11 15.4771525 11 21z" id="path-1"/></defs><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="cast" transform="translate(-1.000000, -3.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Combined-Shape" fill="#000" fill-rule="nonzero" xlink:href="#path-1"/></g></g></svg></a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
死神を恐れないで - GCについて知る【翻訳】</h2><p><time>2017-04-16</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a> <a href=/tags/translation>#translation</a> <a href=/tags/dlang_gc_series>#dlang_gc_series</a> <a href=/tags/d_blog>#d_blog</a></p><div style="border:.5em solid gold;padding:1em;margin-bottom:1em"><p style=font-weight:700;margin:0>これは1年以上前の記事です</p><p style=margin:0>ここに書かれている情報、見解は現在のものとは異なっている場合があります。</p></div><aside><p>Table of Contents</p></aside></header><article><p>この記事は</p><p><a href=http://dlang.org/blog/2017/03/20/dont-fear-the-reaper/>Don’t Fear the Reaper – The D Blog</a></p><p>の翻訳である。
翻訳したものを公開する
<a href=http://dlang.org/blog/2017/03/20/dont-fear-the-reaper/#comment-1355>許可をもらえた</a>
ので、ここに公開する。
誤字や誤訳などを見つけたら今すぐ
<a href=https://github.com/kotet/blog.kotet.jp>Pull request</a>だ!</p><hr><p>Dには、こんにち使用されている多くの言語と同じように、すぐに使えるガベージコレクタがあります。
GCのことを心配せずにかけて、それを最大限活用できるタイプのソフトウェアが多くあります。
しかしGCは不利な点を持ち、ガベージコレクションが望ましくないシナリオがたしかにあります。
そのようなシチュエーションで、言語はそれを一時的に無効化したり、完全に回避する方法を提供します。</p><p>ガベージコレクションのポジティブな影響を最大化し、ネガティブな面を最小化するために、
DでGCがどのように動作するかの下地を持つことが必要です。
スタート地点として最適なのは
<a href=http://dlang.org/spec/garbage.html>dlang.orgのガベージコレクションのページ</a>
でしょう、DのGCの原理を概説し、それを使うためのヒントを提供します。
この投稿はそのページで提供されている情報を拡大するシリーズの最初にするつもりです。</p><p>今回は、非常に基本的なこと、GCアロケーションを引き起こす言語機能にフォーカスしていきます。
将来の投稿で必要な時にGCを無効化する方法や、非決定論的性質に対処するのに役立つイディオムを紹介します
(GCで管理されたオブジェクトのデストラクタのリソースの管理など)。</p><p>まず、Dのガベージコレクタについて理解することは、それがアロケーション中の、
アロケートに利用できるメモリがないときのみ動作するということです。
それは後ろで居座ったりせず、ちらほらヒープをスキャンしゴミ集めをしたりしません。
この知識はGC管理されたメモリを効率的に使うコードを書くことにおいての基本です。
下の例を見てみましょう:</p><pre><code class=language-d>void main() {
    int[] ints;
    foreach(i; 0..100) {
        ints ~= i;
    }
}
</code></pre><p>これは<code>int</code>の動的配列を宣言し、
<a href=https://dlang.org/spec/statement.html#foreach-range-statement>foreachレンジループ</a>
内で0から99までの数字を追加するためにDの追加演算子を使っています。
素人目には追加演算子が配列に追加する値のスペースをアロケートするためにGCヒープを使用していることはわかりません。</p><p>DRuntimeの配列の実装は馬鹿ではありません。
この例の中では、それぞれの値でいちいち100回のアロケーションは行われません。
さらなるメモリが必要なとき、実装は要求されたのより多くのスペースをアロケートします。
この特殊なケースで、実際にどれくらいのアロケーションが行われたかをDの動的配列とスライスの
<a href=https://dlang.org/phobos/object.html#.capacity><code>capacity</code></a>プロパティを使って特定できます。
これはアロケーションが必要になる前に配列が持つことができる要素の合計値を返します。</p><pre><code class=language-d>void main() {
    import std.stdio : writefln;
    int[] ints;
    size_t before, after;
    foreach(i; 0..100) {
        before = ints.capacity;
        ints ~= i;
        after = ints.capacity;
        if(before != after) {
            writefln(&quot;Before: %s After: %s&quot;,
                before, after);
        }
    }
}
</code></pre><p><strong>DMD 2.073.2</strong>でコンパイルしてこれを実行した時、メッセージは6回プリントされ、
これは合計6回のGCアロケーションがループの中であったことを意味します。
つまりGCがゴミを収集する機会が6回あったということです。
この小さな例では、それはほぼ確実に起こりません。
もしこのループがもっと大きなプログラムの一部だった場合、全体にGCのアロケーションがあれば、確実に起こるでしょう。</p><p>付け加えると、これは<code>事前</code>と<code>事後</code>の値を調べることの参考になります。
これを行うと0、3、7、15、31、63、127というシーケンスが見られます。
最終的に、<code>ints</code>には100の値が入り、次のアロケーションの前に27以上の追加できるスペースを持ち、
シーケンスの値から推定するに、255になるでしょう。
これはDRuntimeの実装の詳細ですが、リリースで微調整や変更され得ます。
配列やスライスがGCによってどのように管理されるかのさらなる詳細は、Steven Schveighofferの
このトピックに関する<a href=https://dlang.org/d-array-article.html>素晴らしいアーティクル</a>を見てください。</p><p>それで、6回のアロケーションは、単純で小さなループにおいてもGCがそれを予測不能な長さ休止させる6回の機会です。
一般的に、それはループがコードのホットパートかと、GCヒープから合計どれくらいのメモリが
アロケートされているかに依存する問題になりえます。
しかし、それは必ずしもコードのその部分でGCを無効化する理由にはなりません。</p><p>CやC++のような、独創的なストックGCのついていない言語と同じように、
出来る限り前方でアロケートすることによって全体のパフォーマンスをより良くしたり、
内側のループでのアロケーションを最小化することを多くのプログラマは学びます。
それは本当の諸悪の根源ではなく、<strong>ベストプラクティス</strong>と呼ばれる傾向のある時期尚早な最適化のタイプの1つです。
DのGCがメモリがアロケートされるときにのみ走ることを考えると、
パフォーマンスへの潜在的影響を軽減するシンプルな方法として同じ戦略が適用できます。
こちらは例を書き換えたひとつです:</p><pre><code class=language-d>void main() {
    int[] ints = new int[](100);
    foreach(i; 0..100) {
        ints[i] = i;
    }
}
</code></pre><p>今や6つのアロケーションは1つになりました。
GCが実行される唯一の機会は内側のループの前です。
これは実際にループに入る前に少なくとも100の値のスペースをアロケートし、それらすべてを0で初期化します。
<code>new</code>のあと配列の長さは100になりますが、ほとんど確実に追加のキャパシティがあります。</p><p>配列の<code>new</code>する代わりの方法があります:<code>reserve</code>関数です:</p><pre><code class=language-d>void main() {
    int[] ints;
    ints.reserve(100);
    foreach(i; 0..100) {
        ints ~= i;
    }
}
</code></pre><p>これは少なくとも100の値のメモリをアロケートしますが、返した時点で配列はまだ空(<code>length</code>プロパティは0を返す)
で、デフォルトの初期化はされません。
ループが100個の値のみを追加することを考えると、アロケートが行われないことが保証されます。</p><p><code>new</code>と<code>reserve</code>に加えて、明示的なアロケーションのために<code>GC.malloc</code>を呼ぶことができます。</p><pre><code class=language-d>import core.memory;
void* intsPtr = GC.malloc(int.sizeof * 100);
auto ints = (cast(int*)intsPtr)[0 .. 100];
</code></pre><p><a href=https://dlang.org/spec/arrays.html#dynamic-arrays>配列リテラル</a>
はたいていアロケートをします。</p><pre><code class=language-d>auto ints = [0, 1, 2];
</code></pre><p>これは配列リテラル<code>enum</code>が使われた時にもいえます。</p><pre><code class=language-d>enum intsLiteral = [0, 1, 2];
auto ints1 = intsLiteral;
auto ints2 = intsLiteral;
</code></pre><p><code>enum</code>はコンパイル時にのみ存在し、メモリアドレスを持ちません。
その名前はその値の同義語です。
それをどこで使っても、その値をその場にコピペするようなものです。
<code>ints1</code>と<code>ints2</code>の両方がそのように宣言されたのとちょうど同じようにアロケーションを引き起こします:</p><pre><code class=language-d>auto ints1 = [0, 1, 2];
auto ints2 = [0, 1, 2];
</code></pre><p>ターゲットが
<a href=http://dlang.org/spec/arrays.html#static-arrays>静的配列</a>
の場合配列リテラルはアロケートをしません。
また、文字列リテラル(Dで文字列は内部では配列です)はルールの例外です。</p><pre><code class=language-d>int[3] noAlloc1 = [0, 1, 2];
auto noAlloc2 = &quot;No Allocation!&quot;;
</code></pre><p>連結演算子は常にアロケートをします:</p><pre><code class=language-d>auto a1 = [0, 1, 2];
auto a2 = [3, 4, 5];
auto a3 = a1 ~ a2;
</code></pre><p>Dの<a href=https://dlang.org/spec/hash-map.html>連想配列</a>は独自のアロケーション戦略をもちますが、
あなたはアイテムが追加されたり潜在的に削除されたりした時にアロケートされることを期待します。
連想配列は2つのプロパティ、<code>key</code>と<code>value</code>を公開し、これらは配列をアロケートし、
それぞれのアイテムのコピーで埋めるものです。
イテレーション中にもとの連想配列を変更することを望む場合、
またはそのアイテムがソートされている必要があるとき、
または連想配列と独立して操作されるとき、これらのプロパティはまさにちょうど必要なものです。
そうでなければ、これらはGCに過度の負荷をかける余計なアロケーションです。</p><p>GCが走るとき、スキャンが必要なメモリの合計の量はそのガベージコレクションがどれだけかかるかを決めます。
小さいことは、良いことです。
不必要なアロケーションを避けることは誰にも害を及ぼさず、別の良い軽減戦略です。
そのようなことをするために
<a href=http://dlang.org/spec/hash-map.html#properties>Dの連想配列は3つのプロパティを提供します</a>:
<code>byKey</code>、<code>byValue</code>、<code>byKeyValue</code>です。
これらはそれぞれlazyにイテレートされるforwardレンジを返します。
これらは実際に連想配列のアイテムを参照し、それがイテレート中に変更されないためアロケートを行いません。
レンジの詳細については、Ali Çehreliの
<a href=http://ddili.org/ders/d.en/index.html>Programming in D</a>の
<a href=http://ddili.org/ders/d.en/ranges.html>Ranges</a>と
<a href=http://ddili.org/ders/d.en/ranges_more.html>More Ranges</a>のチャプターを見てください。</p><p>ローカルスタックフレームのポインタを持ち歩く必要があるデリゲートまたは関数リテラルである
<a href=https://dlang.org/spec/function.html#closures>クロージャ</a>は、アロケートをすることがあります。
<a href=http://dlang.org/spec/garbage.html>Garbage Collectionのページ</a>
の最後にリストアップされているアロケートをする言語機能は
<a href=http://dlang.org/spec/expression.html#AssertExpression>アサーション</a>です。
アサーションはDのクラスベースヒエラルキーの一部である<code>AssertError</code>を投げる必要があるため、
それが失敗した時アロケートします(今後の投稿でクラスがGCとどのようにやり取りをするか見ていきます)。</p><p>ところで、Dの標準ライブラリの<a href=https://dlang.org/phobos/index.html>Phobos</a>というのがあります。
かつて、PhobosのほとんどはGCアロケーションをほぼ気にせず実装されており、
それがGCアロケーションが望ましくないシチュエーションでのPhobosの使用を難しくしていました。
しかし、GCの使用についてより保守的にする大きな取り組みが開始されました。
いくつかの関数はlazyなレンジで動作するようになり、
他のものは呼び出し側の提供するバッファをとるように書きなおされ、
さらにいくつかは内部的に不必要なアロケーションを避けるよう再実装されました。
結果として標準ライブラリはよりGCフリーのコードに対して素直になりました
(が、おそらくまだライブラリの隅にまだ改装されていないものがあります
— <a href=https://github.com/dlang/phobos>PRを受け付けています</a>)。</p><p>GCの使用の基礎を見てきたので、このシリーズの次の投稿ではGCをオフにし特定のセクションがGCフリーである
ことを確かめる、言語とコンパイラが提供するツールについて紹介します。</p><p>この記事について協力してくれたGuillaume PiolatとSteven Schveighofferに感謝します。</p></article><footer><h2><a href=/tags/dlang>#dlang</a>
死神を恐れないで - GCについて知る【翻訳】</h2><p><time>2017-04-16</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a> <a href=/tags/translation>#translation</a> <a href=/tags/dlang_gc_series>#dlang_gc_series</a> <a href=/tags/d_blog>#d_blog</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>