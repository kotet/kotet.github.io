<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="これは、強い人が多すぎてもはやCコンパイラ書いた程度では面白味がない気がしてくる D言語 Advent Calendar 2018 11日目の記事です。 この記事の対象読者は過去の自"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.02c91f0bdf54d569f6c715f0a345bf32b55cd4d3ac11e0b98fec7ad1e614c151.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang 君もDでx86_64向けCコンパイラを書こう - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2018/12/compiler-in-d/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#dlang 君もDでx86_64向けCコンパイラを書こう - Kotet's Personal Blog"><meta name=og:description content="これは、強い人が多すぎてもはやCコンパイラ書いた程度では面白味がない気がしてくる D言語 Advent Calendar 2018 11日目の記事です。 この記事の対象読者は過去の自"><meta name=twitter:image content=https://blog.kotet.jp/img/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2018/12/compiler-in-d/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.55.2"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><span class=text-up>ABOUT</span><a href=/about title=about><svg width="22" height="22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="info" transform="translate(-1.000000, -1.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M12 23C5.92486775 23 1 18.0751322 1 12 1 5.92486775 5.92486775 1 12 1 18.0751322 1 23 5.92486775 23 12 23 18.0751322 18.0751322 23 12 23zm0-2C16.9705627 21 21 16.9705627 21 12 21 7.02943725 16.9705627 3 12 3 7.02943725 3 3 7.02943725 3 12 3 16.9705627 7.02943725 21 12 21zM13.0036109 13.9983464H14.0029544v2h-4v-2h1v-2h-1V9.99834639h3.0006565V13.9983464zM12.0003283 8.99834639C11.4478622 8.99834639 11 8.55063114 11 7.99834639 11 7.44606164 11.4478622 6.99834639 12.0003283 6.99834639 12.5527943 6.99834639 13.0006565 7.44606164 13.0006565 7.99834639c0 .5522847500000001-.44786219999999943 1-1.0003282000000002 1z" id="Oval-17" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>DOWNLOAD</span><a href=/products title=download><svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="download" transform="translate(-2.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M22 16v4C22 21.1045695 21.1045695 22 20 22H4C2.8954305 22 2 21.1045695 2 20V16H4v4H20V16h2zm-9-3.4142136L16.2928932 9.29289322 17.7071068 10.7071068 12 16.4142136 6.29289322 10.7071068 7.70710678 9.29289322 11 12.5857864V2h2V12.5857864z" id="Combined-Shape" fill="#000"/></g></g></svg></a></li><li><span class=text-up>TAG</span><a href=/tags title=tag><svg width="22" height="14" viewBox="0 0 22 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="tag" transform="translate(-1.000000, -5.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M6.53518376 5H21C22.1045695 5 23 5.8954305 23 7V17C23 18.1045695 22.1045695 19 21 19H6.53518376C5.86647738 19 5.24201473 18.6657977 4.87108317 18.1094004L1.16794971 12.5547002C.944016765 12.2188008.944016765 11.7811992 1.16794971 11.4452998L4.87108317 5.89059961C5.24201473 5.33420227 5.86647738 5 6.53518376 5zM3.20185043 12l3.33333333 5H21V7H6.53518376L3.20185043 12zM7 13C6.44771525 13 6 12.5522847 6 12 6 11.4477153 6.44771525 11 7 11 7.55228475 11 8 11.4477153 8 12 8 12.5522847 7.55228475 13 7 13z" id="Rectangle-29" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>PODCAST</span><a href=https://podcast.kotet.jp title=podcast><svg width="22" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="broadcasting" transform="translate(-1.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M9.38742589 20 8.72075922 22H6.61257411L9.89881747 12.1412699C9.34410225 11.5968755 9 10.8386225 9 10 9 8.34314575 10.3431458 7 12 7 13.6568542 7 15 8.34314575 15 10 15 10.8386225 14.6558977 11.5968755 14.1011825 12.1412699L17.3874259 22H15.2792408L14.6125741 20H9.38742589zM10.7207592 16 10.0540926 18H13.9459074L13.2792408 16H10.7207592zM11.3874259 14H12.6125741L12.2750928 12.987556C12.1844984 12.9957918 12.0927406 13 12 13 11.9072594 13 11.8155016 12.9957918 11.7249072 12.987556L11.3874259 14zM12 11C12.5522847 11 13 10.5522847 13 10 13 9.44771525 12.5522847 9 12 9 11.4477153 9 11 9.44771525 11 10 11 10.5522847 11.4477153 11 12 11zm8.108743-8.43301443C21.9041909 4.52460368 23 7.13433188 23 10 23 12.8656681 21.9041909 15.4753963 20.108743 17.4330144L18.6344261 16.0815573C20.103429 14.4798697 21 12.3446376 21 10 21 7.65536245 20.103429 5.52013028 18.6344261 3.91844274L20.108743 2.56698557zM17.1601092 5.26989991C18.302667 6.51565689 19 8.17639301 19 10 19 11.823607 18.302667 13.4843431 17.1601092 14.7301001L15.6857923 13.3786429C16.501905 12.4888165 17 11.3025764 17 10 17 8.69742358 16.501905 7.51118349 15.6857923 6.62135708L17.1601092 5.26989991zM3.89125699 2.56665655 5.3655739 3.91811372C3.89657104 5.51980126 3 7.65503343 3 9.99967098 3 12.3443085 3.89657104 14.4795407 5.3655739 16.0812282L3.89125699 17.4326854C2.09580905 15.4750673 1 12.8653391 1 9.99967098 1 7.13400286 2.09580905 4.52427466 3.89125699 2.56665655zM6.83989081 5.26957089 8.31420772 6.62102806C7.49809502 7.51085447 7 8.69709456 7 9.99967098 7 11.3022474 7.49809502 12.4884875 8.31420772 13.3783139L6.83989081 14.7297711C5.69733303 13.4840141 5 11.823278 5 9.99967098 5 8.17606399 5.69733303 6.51532787 6.83989081 5.26957089z" id="Combined-Shape" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-up>FEED</span><a href=/index.xml title=feed><svg width="22" height="18" viewBox="6 8 .5 10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs><path d="M1 21V19C2.1045695 19 3 19.8954305 3 21H1zm6 0H5C5 18.790861 3.209139 17 1 17V15C4.3137085 15 7 17.6862915 7 21zm4 0H9C9 16.581722 5.418278 13 1 13V11C6.5228475 11 11 15.4771525 11 21z" id="path-1"/></defs><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="cast" transform="translate(-1.000000, -3.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Combined-Shape" fill="#000" fill-rule="nonzero" xlink:href="#path-1"/></g></g></svg></a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
君もDでx86_64向けCコンパイラを書こう</h2><p><time>2018-12-11</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/assembly>#assembly</a> <a href=/tags/tech>#tech</a> <a href=/tags/advent-calendar>#advent-calendar</a></p><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#d9cc-a-small-c-compiler-written-in-d>d9cc : A Small C Compiler Written in D</a></li><li><a href=#なぜcコンパイラを書くのか>なぜCコンパイラを書くのか</a><ul><li><a href=#幅広い知識が自然に身につく>幅広い知識が自然に身につく</a><ul><li><a href=#アセンブリ>アセンブリ</a></li><li><a href=#パーサー>パーサー</a></li><li><a href=#意味解析>意味解析</a></li><li><a href=#各種ツール>各種ツール</a></li></ul></li><li><a href=#色んな応用の世界が広がる>色んな応用の世界が広がる</a></li></ul></li><li><a href=#9ccと-低レイヤを知りたい人のための-cコンパイラ作成入門-の相違点>9ccと「低レイヤを知りたい人のための Cコンパイラ作成入門」の相違点</a></li><li><a href=#なぜd言語なのか>なぜD言語なのか</a><ul><li><a href=#コンパイラが書ける>コンパイラが書ける</a></li><li><a href=#c言語に近い>C言語に近い</a></li><li><a href=#書き慣れている>書き慣れている</a></li></ul></li><li><a href=#cコンパイラを書け>Cコンパイラを書け</a></li><li><a href=#日記-コミットログ>日記（コミットログ）</a></li></ul></li></ul></li></ul></nav></aside></header><article><p>これは、強い人が多すぎてもはやCコンパイラ書いた程度では面白味がない気がしてくる
<a href=https://qiita.com/advent-calendar/2018/dlang>D言語 Advent Calendar 2018</a>
11日目の記事です。</p><p>この記事の対象読者は過去の自分、
つまりコンパイラとかに興味があっていろいろ調べたりはするけどそこで満足してなかなか行動に移せないあなたです。
この記事を通して、
自分は読者であるあなたに<strong>D言語で</strong>Cコンパイラを書いてもらえるように全力で説得していきます。</p><p>あなたもD言語を書きましょう。
Cコンパイラを書きましょう。
D言語でCコンパイラを書きましょう。</p><p>あなたとD、<a href=https://dlang.org/download.html>今すぐダウンロード</a>。</p><h3 id=d9cc-a-small-c-compiler-written-in-d>d9cc : A Small C Compiler Written in D</h3><p>ここ最近9ccのコミットログをたどってCコンパイラを書いていました。</p><p><a href=https://github.com/kotet/d9cc>kotet/d9cc: A Small C Compiler Written in D</a></p><p>この記事を読んだのが書き始めた理由でした。</p><p><a href=https://www.utam0k.jp/blog/2018/10/12/r9cc/>1人でがんばる自作Cコンパイラ</a></p><p>前々からコンパイラとか書いてみたいし、アセンブリも読めるようになりたいな、
とは思って定期的に勉強しようとしていましたが、
どうも途中でくじけてしまって毎回同じところをぐるぐるしていました。
そこで上の記事を見て、なるほどそういう勉強法がうまくいくんだなあと思い、
書き始めてみたら結構うまくいきました。</p><p><a href=https://ja.wikipedia.org/wiki/%E3%82%A8%E3%82%A4%E3%83%88%E3%83%BB%E3%82%AF%E3%82%A4%E3%83%BC%E3%83%B3>N-queen</a>
が動くくらいにはできています。
あと9ccにはないオリジナル機能として、
<a href=https://ja.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E6%A7%8B%E6%96%87%E6%9C%A8>抽象構文木</a>
を
<a href=https://ja.wikipedia.org/wiki/Graphviz>Graphviz</a>
のdotファイル形式で出力するオプションがあります。</p><p><img src=/img/blog/2018/12/ast1.svg alt>
<img src=/img/blog/2018/12/ast2.svg alt></p><p>上：<code>int main(int argc, char **argv) {int a = (1+2+3)*7; return a;}</code>のASTを可視化したもの（<code>-dump-ast1</code>オプションを渡すと生成される）<br>下：上のASTを意味解析したもの（<code>-dump-ast2</code>オプションを渡すと生成される）</p><p>9ccには浮動小数点数も存在しないのでこれもオリジナル機能として実装してみようかと思ったりもしましたが、
思ってるうちにやる気が減衰してきて実現できていません。</p><h3 id=なぜcコンパイラを書くのか>なぜCコンパイラを書くのか</h3><p>しかしなぜいまさら<a href=https://ja.wikipedia.org/wiki/X64>x86_64</a>向けCコンパイラなどというありふれたものを作るのでしょうか？
実はある種の分野の勉強をするのにCコンパイラは最適な題材なのです。</p><p>プログラミングの学習を始めたばかりの時、コンパイラは一種魔法のように見えました。
テキストデータであるプログラムの「構造を解析して」、「意味を与え」、「機械語に翻訳」する？！
そんなことが本当に可能なのでしょうか？</p><p>かなり前に「コンピュータは論理の世界と現実の世界をどのようにつないでいるのですか？」
といったような質問をYahoo!知恵袋で見たことがあります。
その人にとってコンピュータはまさに魔法であり、異世界と通じあい問いと答えを交換するゲートだったのです。
それと同じことが自分にも、コンパイラにおいて起きていました。</p><p>しかし、Cコンパイラを一度書くとコンパイラは魔法ではなくなります。
理解できる技術として身につけることができるのです。</p><h4 id=幅広い知識が自然に身につく>幅広い知識が自然に身につく</h4><p>Cコンパイラを書くことで様々な知識を身につけることができて、
コンピュータの学習曲線の大きなジャンプを乗り越えることができます。
以下、自分が理解できて特に嬉しかったことを書いていきます。</p><h5 id=アセンブリ>アセンブリ</h5><p>以前コンパイラを書こうと思った時は、
まず<a href=https://ja.wikipedia.org/wiki/%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AA%E8%A8%80%E8%AA%9E>アセンブリ</a>
を読めるようになろうと思ってアセンブリ手書きから学習をはじめました。
しかしいきなりアセンブリを学ぼうとすると前提知識が大量に必要になり、
Hello Worldの文面を書き換える程度の改造しかできませんでした。</p><p>まずアセンブリの基本的な考え方を知らないので、
命令単体のリファレンスを読んでもそれが結局何をしたいのか理解できず、
したがってコードの意図が全くわからないのです。
他の言語と同じノリでいきなりHello Worldから始めてしまったのも敗因かもしれません。</p><p>9ccは非常に単純なアセンブリから出発しており、しかも期待される実行結果がテストとして書かれています。
プログラムに書いてあることがそのコードを生成するのに必要なすべてなので、
学習範囲をその中に書いてあることだけに絞ることができます。
また、コンパイラのコードは本質的にアセンブリを書いていく手順を表しているので、
アセンブリのこの行になぜこの命令があるのか、ということを理解する助けになります。</p><p>コンパイル対象のC言語が難しくなっていくにつれてアセンブリも長く複雑になっていきますが、
1コミットあたりの変更は少ないのでその場その場で学ばなければいけないことは非常に少なくなります。
実際1コミットあたりで学んだ命令は平均して1個未満という感じだったと思います。</p><h5 id=パーサー>パーサー</h5><p>1つづつコミットを読んでいくといきなり「
<a href=https://ja.wikipedia.org/wiki/%E5%86%8D%E5%B8%B0%E4%B8%8B%E9%99%8D%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90>再帰下降構文解析</a>
器を作る」というコミットが現れます。
そこそこ行数が多くて苦労しましたが、その時点でのコンパイル対象はカッコもないただの四則演算だったので、
それを処理するパーサーも十分小さく、無事に理解できました。</p><p>基本がわかればあとは簡単です。
パーサジェネレータなどという自動化ツールが存在するくらいには同じことの繰り返しなので、
難しそうな構文もパターンにあてはめればスムースに理解できます。</p><h5 id=意味解析>意味解析</h5><p>パースを行うと構文木ができあがります。
これを書き換えたりすることでさまざまな処理を行います。
意味解析、という言葉は具体的に何をすればいいのかわかりにくいです。
コンパイラについて述べた文章でも意味解析については抽象的な説明が行われることが多く、
なんだか魔法のような印象を受けます。</p><p>しかし具体的なコードを読めば何をしているか理解できます。
具体的な内容を理解した上で感想を言うと、
どうも直接関連しないさまざまな処理をおおざっぱにまとめて「意味解析」
と呼んでいることで混乱を呼ぶのではないか、という気がします。</p><h5 id=各種ツール>各種ツール</h5><p>開発に関連したツールにも習熟しました。
gccのオプションも知らないものがたくさんあったし、
そもそもC言語の仕様をここまで詳細に調べたこともありませんでした。
gitの使い方もかなり上手になりました。
何度もコミットを移動するので、効率的な方法を多数身につけました。</p><p>gdbの使い方を理解したのはかなり大きいかもしれません。
これまではセグフォが起きると原因になりそうなところを総当りでprintfデバッグして、
結局わからなくて諦めていた記憶があります。</p><h4 id=色んな応用の世界が広がる>色んな応用の世界が広がる</h4><p>一度Cコンパイラの具体的実装を理解すると、それを応用してさまざまなものが作れるとわかります。
まず他の言語やISAに対するコンパイラを書くことができます。
今到達している範囲で定数畳み込みはまだ出てきていませんが、
今までのコードからどんなものを書けばいいか大体推測できます。
さらに、式変形を自動で行うタイプのプログラムもだいたい作れそうな気がしてきます。
実際論理式の展開くらいなら１日あればフルスクラッチから書けるようになります。</p><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr>移動中にほぼ何も見ずにパーサが書けるようになっている……！ <a href=https://t.co/K1r0lI1WKf>pic.twitter.com/K1r0lI1WKf</a></p>&mdash; Kotet (@kotetttt) <a href="https://twitter.com/kotetttt/status/1064327578469642241?ref_src=twsrc%5Etfw">2018年11月19日</a></blockquote><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr>成長を感じる <a href=https://t.co/Unb8xQ0zWi>pic.twitter.com/Unb8xQ0zWi</a></p>&mdash; Kotet (@kotetttt) <a href="https://twitter.com/kotetttt/status/1064525855047602176?ref_src=twsrc%5Etfw">2018年11月19日</a></blockquote><p>あと<a href="https://www.youtube.com/watch?v=0-vWT-t0UHg">malloc動画</a>
の言ってることが理解できるようになりました。</p><p>Cコンパイラを作ったことによって、その知識を応用できるようになり、
作れるものの範囲が一気に広がりました。</p><h3 id=9ccと-低レイヤを知りたい人のための-cコンパイラ作成入門-の相違点>9ccと「低レイヤを知りたい人のための Cコンパイラ作成入門」の相違点</h3><p>d9ccを書いている途中で「低レイヤを知りたい人のための Cコンパイラ作成入門」の一部が
<a href=https://www.sigbus.info/compilerbook/>公開されました</a>が、
9ccはこの本と作成過程が異なるようです。
本ではスタックマシンを作っていましたが、9ccでは最初からレジスタマシンを書き始めています。
スタックにまかせている部分を自分で書くことになるわけですが、そんなに難しいとも思わなかったので、
人によっては自分のように9ccのコミットログをたどる学習法のほうがしっくりくるかもしれません。</p><h3 id=なぜd言語なのか>なぜD言語なのか</h3><p><blockquote class=twitter-tweet data-lang=ja><p lang=ja dir=ltr>いきなりD言語が飛び出してきてびっくりした<br>低レイヤを知りたい人のための Cコンパイラ作成入門 <a href=https://t.co/NEdfJaCcOp>https://t.co/NEdfJaCcOp</a> <a href=https://t.co/ZKQnIjvAQ1>pic.twitter.com/ZKQnIjvAQ1</a></p>&mdash; Kotet (@kotetttt) <a href="https://twitter.com/kotetttt/status/1058195569632407552?ref_src=twsrc%5Etfw">2018年11月2日</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></p><p>Cコンパイラを書くメリットは上のとおりですが、ではなぜD言語でなければいけないのでしょうか？
一般的には他の言語で書いてもいいし、C言語で書けばセルフホストができます。
しかし自分にはD言語を使う理由があります。</p><h4 id=コンパイラが書ける>コンパイラが書ける</h4><p>Cコンパイラくらい<a href=http://shinh.skr.jp/elvm/8cc.c.eir.bf>brainf*ckですら作れる</a>
のでこれはそんなに重要ではないですが、
D言語で書かれたコンパイラがたくさんあります。
まずD言語のコンパイラDMDそのものがD言語で書かれています。</p><p>9ccを元にD言語でコンパイラを書いた人が自分以外にいたりもします。</p><p><a href=https://github.com/alphaKAI/d9cc>alphaKAI/d9cc: A tiny C compiler in Dlang</a></p><p>これはコミットログを順にたどっている自分とは違い、9ccの最新バージョンを直接Dに移植したもののようです。
自分のd9ccは9ccのコードの意味を少しづつ理解しながら手探りで書いたのでだいぶコードが混乱していますが、
こちらのd9ccはビルドツールとしてDUBを使っていたりして、少しすっきりしています。</p><p>ともかく、<del>言語の知名度の割に</del>9ccの移植が複数存在するほどD言語はこの分野に向いているわけです。</p><h4 id=c言語に近い>C言語に近い</h4><p>D言語は「<a href=http://www.kmonos.net/alang/d/>C言語風の構文を持つ静的型付け言語</a>」であり、
基本的には高機能なCとして書くことができます。
コピペにならないようにC以外の言語を使いたかったのですが、
一方でC言語から離れすぎると書き直すのが大変になるので、
C言語と似ていながらC++のように完全な互換性があるわけでもないD言語は妥当な選択肢のひとつでした。</p><h4 id=書き慣れている>書き慣れている</h4><p>そしてこれが最も大きな理由かもしれません。
自分はD言語を書き慣れていました。
先程話したように自分はコンパイラを作ろうとして何度も挫折してきました。
できればセルフホストとかしてみたいですが、
まず一度スタンダードなものを完成させられないようでは、応用もできません。</p><p>なので今回こそは成功させようと、「Cコンパイラを作る」以外のあらゆる点で背伸びをせず、
「まず一度完成させること」を大事にしました。
言語選択においてもそれを考慮した結果、言語特有の問題で詰んだりしないような、
書き慣れているD言語が選ばれました。</p><p>D言語は非常に書きやすく、やりたいことを実現するのがとても簡単な言語です。
あなたも「現実的なプログラマのための、 現実的な言語」でコンパイラを書きましょう。</p><h3 id=cコンパイラを書け>Cコンパイラを書け</h3><p>自分はCコンパイラを書いて得た知識で作ってみたいものがいろいろできたので今後はそれを書きます。
言語やISAを変えて別のコンパイラを作ってみるのもいいかもしれません。</p><p>Cコンパイラは書くだけで大量の知識が手に入る最強の教材です。
そしてD言語は書くだけで救われる最強の言語です。
したがって全人類はD言語でCコンパイラを書くべきです。</p><p>コンパイラの構造などに関してコメントが書かれている9ccに対して、
d9ccはアセンブリなどの周辺知識に関して多くのコメントを残しており、
しかも日本語なので（何かのバグでちょっと壊れてるけど）、
9ccと一緒に読むと9cc単体よりも理解がしやすいと思います。</p><p>以下はd9ccのコミットログを整形したものです。
途中調べたサイトなどのリンクが残してあるので、
この記事を読んでコンパイラが作りたくなったら参考にするといいかもしれません。</p><h3 id=日記-コミットログ>日記（コミットログ）</h3><ul><li><p>commit 63f4f3332a68e65990de7f416608da5580cc7f46<br>Date: Sun Oct 14 16:53:15 2018 +0900</p><p>Initial commit</p><p>コンパイラを作りたいと思っていろいろ頑張ってみていたが、
少し進んで挫折することを繰り返していた。
そんななか
<a href=https://www.utam0k.jp/blog/2018/10/12/r9cc/>1人でがんばる自作Cコンパイラ</a>
を読んで「その手があったか！」と思い、自分もやってみることにした。</p><p>正直にいうと写経という選択肢が全く頭になかったわけではないが、
あまり写経経験がなかったことや、せっかくなら真似ではなく、
理屈を理解してオリジナルで作ってみたかったことなどから除外していた。</p><p>しかし行き詰まっているときに上の記事が出たことで、
ちょっとやってみようという気になった。
結局自分は先行事例を追いかけることしかできないのかもしれない。</p></li><li><p>commit 9835503a5c1d38822b1a94be2c482920b69b07a7<br>Date: Sun Oct 14 17:24:48 2018 +0900</p><p>Compile a single number to a program that exits with the given number.</p><p><a href=https://www.slogical.co.jp/tech/unixc_gccstatic.html>- 株式会社エスロジカル - 技術ドキュメント UNIX の C言語：gccのstaticオプション</a><br><a href="http://capm-network.com/?tag=GAS_Intel%E8%A8%98%E6%B3%95%E3%81%AE%E5%88%A9%E7%94%A8">GAS_Intel記法の利用 CapmNetwork</a><br><a href=http://softwaretechnique.jp/OS_Development/Tips/IA32_Instructions/MOV.html>Tips　IA32（x86）命令一覧　Mから始まる命令　MOV命令</a></p><p>4 files changed, 50 insertions(+)</p></li><li><p>commit f8723100d891408df913da5e2b21da93eafaa806<br>Date: Sun Oct 14 17:56:10 2018 +0900</p><p>Add &ldquo;+&rdquo; and &ldquo;-&rdquo;</p><p><a href=https://www.k-cube.co.jp/wakaba/server/format.html>フォーマット指定子一覧</a><br><a href=http://www9.plala.or.jp/sgwr-t/lib/strtol.html>strtol</a></p><p>2 files changed, 39 insertions(+), 2 deletions(-)</p></li><li><p>commit 9c58812ae0f4916dae235fcceb01f7672ee8eacf<br>Date: Mon Oct 15 10:25:58 2018 +0900</p><p>Add a tokenizer to allow whitespace between tokens</p><p><a href=https://stackoverflow.com/questions/33054713/d-how-to-exit-from-main>D: How to exit from main? - Stack Overflow</a></p><p>2 files changed, 118 insertions(+), 17 deletions(-)</p></li><li><p>commit cb583ec6b7d76d85889fa5174f3b437214404c29<br>Date: Mon Oct 15 15:39:36 2018 +0900</p><p>Implement a recursive descendent parser</p><p><a href=https://ja.wikipedia.org/wiki/%E5%86%8D%E5%B8%B0%E4%B8%8B%E9%99%8D%E6%A7%8B%E6%96%87%E8%A7%A3%E6%9E%90>再帰下降構文解析 - Wikipedia</a><br><a href=https://qiita.com/7shi/items/64261a67081d49f941e3>Java 再帰下降構文解析 超入門</a><br><a href=https://tanakamura.github.io/pllp/docs/>実践的低レベルプログラミング</a></p><p>出てきた値を順番にレジスタに割り当てていき、順番に足し合わせていく。
8個以上の数値を入力するとレジスタが枯渇する。</p><p>2 files changed, 100 insertions(+), 30 deletions(-)</p></li><li><p>commit a3826a9dbd695ff931bc48ce9bccaf072921f884<br>Date: Tue Oct 16 11:20:49 2018 +0900</p><p>Add intermediate representation</p><p>中間表現を間に挟むことによってレジスタの使い回しをする</p><p>2 files changed, 165 insertions(+), 27 deletions(-)</p></li><li><p>commit e2e19bc7e46261a83e8459a327d5633662fa8e2f<br>Date: Tue Oct 16 11:59:13 2018 +0900</p><p>Split into multiple .d files</p><p><a href=http://kaworu.jpn.org/c/gdb%E3%81%A7%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AEgcc%E3%81%AE%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E6%83%85%E5%A0%B1%E3%81%AE%E3%82%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3>gdbでデバッグするためのgccのデバッグ情報のオプション - C言語入門</a></p><p>9 files changed, 407 insertions(+), 360 deletions(-)</p></li><li><p>commit 9e107a391cd12909bfe37c934ebc16f1bd5a75e2<br>Date: Tue Oct 16 14:28:05 2018 +0900</p><p>Add &lsquo;*&rsquo; operator</p><p><a href=http://softwaretechnique.jp/OS_Development/Tips/IA32_Instructions/MUL.html>Tips　IA32（x86）命令一覧　Mから始まる命令　MUL命令</a></p><p>6 files changed, 54 insertions(+), 10 deletions(-)</p></li><li><p>commit d579df90eb48ea99e4e084e2a4e3757434e32408<br>Date: Tue Oct 16 14:46:49 2018 +0900</p><p>Add &lsquo;/&rsquo; operator</p><p><a href=http://softwaretechnique.jp/OS_Development/Tips/IA32_Instructions/DIV.html>Tips　IA32（x86）命令一覧　Dから始まる命令　DIV命令</a><br><a href=https://ja.wikipedia.org/wiki/%E7%AC%A6%E5%8F%B7%E6%8B%A1%E5%BC%B5>符号拡張 - Wikipedia</a><br><a href=https://www.mztn.org/lxasm64/amd07_mov.html#cwd>Assembly Programming on x86-64 Linux (07)</a></p><p>4 files changed, 14 insertions(+), 1 deletion(-)</p></li><li><p>commit b9b60502014477e2a3f99750ed9281cda585be9a<br>Date: Wed Oct 17 12:32:39 2018 +0900</p><p>Add compound statement and return statement</p><p>7 files changed, 148 insertions(+), 62 deletions(-)</p></li><li><p>commit 45595f223b1daaa29e6596a1ca46fb66dcd63bdb<br>Date: Wed Oct 17 20:01:33 2018 +0900</p><p>Add variable</p><p>7 files changed, 175 insertions(+), 30 deletions(-)</p></li><li><p>commit d39e012e8bff1a60fef6aa39c72ae0e5c889cb00<br>Date: Thu Oct 18 10:01:30 2018 +0900</p><p>Add ADD_IMM IR insn that takes an immediate number</p><p>少し先のコミットで専用命令にまとめられてたのでそちらを先取り。</p><p>3 files changed, 9 insertions(+), 11 deletions(-)</p></li><li><p>commit f4db422d21a3f1b95360fd33d89abe856ac40153<br>Date: Thu Oct 18 10:45:15 2018 +0900</p><p>Add &lsquo;()&rsquo;</p><p>3 files changed, 15 insertions(+), 2 deletions(-)</p></li><li><p>commit 022e964611668b375fbd83c15e4da1bee9cd7fe2<br>Date: Thu Oct 18 18:52:06 2018 +0900</p><p>Add &lsquo;if&rsquo;</p><p><a href=http://softwaretechnique.jp/OS_Development/Tips/IA32_Instructions/CMP.html>Tips　IA32（x86）命令一覧　Cから始まる命令　CMP命令</a><br><a href="http://capm-network.com/?tag=x86-%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF">x86-レジスタ CapmNetwork</a><br><a href=https://vanya.jp.net/os/x86call/>x86アセンブリ言語での関数コール</a></p><p>変数まわりの動きがよくわかっていなかったのだが、
<a href=https://vanya.jp.net/os/x86call/>x86アセンブリ言語での関数コール</a>
を読んで理解することができた。
紙に書いてみるのも難しかったのでインタラクティブなサンプルは非常にありがたい。</p><p>7 files changed, 195 insertions(+), 62 deletions(-)</p></li><li><p>commit 99e801f31896e45b8648c5c252644b381a81f2b5<br>Date: Fri Oct 19 12:51:50 2018 +0900</p><p>Add &lsquo;else&rsquo;</p><p>5 files changed, 29 insertions(+), 3 deletions(-)</p></li><li><p>commit 92a0d2141eb36267b830491f95c8a0f146e1a2c1<br>Date: Fri Oct 19 19:20:01 2018 +0900</p><p>Add function call</p><p><a href=https://jp.xlsoft.com/documents/intel/compiler/17/cpp_17_win_lin/GUID-011A435D-F8D0-46D7-B973-9B704CA5B54E.html>C/C++ の呼び出し規約</a><br><a href=https://www3.nd.edu/~dthain/courses/cse40243/fall2017/intel-intro.html>Introduction to X86-64 Assembly for Compiler Writers</a><br><a href=http://herumi.in.coocan.jp/prog/x64.html#GCC64>x64 Assembly Language Programming</a><br><a href=https://stackoverflow.com/questions/18024672/what-registers-are-preserved-through-a-linux-x86-64-function-call>assembly - What registers are preserved through a linux x86-64 function call - Stack Overflow</a><br><a href=https://ja.wikipedia.org/wiki/%E5%91%BC%E5%87%BA%E8%A6%8F%E7%B4%84#vectorcall_2>呼出規約 - Wikipedia</a></p><p>7 files changed, 89 insertions(+), 4 deletions(-)</p></li><li><p>commit 96d040ca134ca5a2d9b2768547e5b3f138293a1a
Date: Sun Oct 21 16:14:23 2018 +0900</p><p>Add zero-arity function definition</p><p><a href=https://ja.wikipedia.org/wiki/%E3%82%A2%E3%83%AA%E3%83%86%E3%82%A3>アリティ - Wikipedia</a></p><p>Typoで関数呼び出し時の<code>push</code>と<code>pop</code>が対応してないバグに気づくまでかなり時間がかかった。
そろそろgdbが使えるようにならないとデバッグが辛いと悟った。
とりあえず<code>display /x $&lt;レジスタ名&gt;</code>して<code>stepi</code>しまくれば良いと思う。</p><p>7 files changed, 166 insertions(+), 81 deletions(-)</p></li><li><p>commit 2442f90ead1720cba8f3f41f18e1512434304fe2<br>Date: Sun Oct 21 17:27:14 2018 +0900</p><p>Remove IRType.AlLOCA</p><p>addには負数が渡せる。
でもなんでsubを使わずあえてaddを選んだんだろう？</p><p>3 files changed, 39 insertions(+), 44 deletions(-)</p></li><li><p>commit ac5c139deba710f116d3820b84613ae273de96d3<br>Date: Sun Oct 21 19:48:08 2018 +0900</p><p>Remove unused variable</p><p>やっぱり即値subを使うようだ。</p><p>4 files changed, 51 insertions(+), 5 deletions(-)</p></li><li><p>commit 534749b8836370e41517c4ed89633b616e07a872<br>Date: Sun Oct 21 19:54:24 2018 +0900</p><p>Rename codegen.d -&gt; gen_x86.d, ir.d -&gt; gen_ir.d</p><p>4 files changed, 6 insertions(+), 6 deletions(-)</p></li><li><p>commit 2391660ec4b6c0d2f8ac3cc33f0a303d16e34887<br>Date: Sun Oct 21 20:00:36 2018 +0900</p><p>Create LICENSE</p><p>GitHubで自動生成</p></li></ul><p>1 file changed, 21 insertions(+)</p><ul><li><p>commit 804b9a2775f3690ff610093ff206aa500956d626<br>Date: Sun Oct 21 20:10:54 2018 +0900</p><p>Add .travis.yml</p><p>1 file changed, 6 insertions(+)</p></li><li><p>commit 1e7b36fc355422bbd80eb9bf6eafd44d223c2d38<br>Date: Mon Oct 22 19:53:07 2018 +0900</p><p>Add &ldquo;&amp;&amp;&rdquo; and &ldquo;||&rdquo;</p><p><a href=http://endeavour.cocolog-nifty.com/developer_room/2012/05/ctruefalse-8e91.html>C言語：TRUEとFALSEの値: 愛ゆえにプログラムは美しい</a><br><a href=https://www.grapecity.com/developer/support/powernews/column/clang/020/page05.htm>もう一度基礎からC言語 第20回 いろいろな演算子～演算子の優先順位 演算子の優先順位と結合規則</a></p><p>ただの論理演算なのにジャンプ命令がいっぱい吐かれて何事かと思った。
短絡評価をする場合は当然制御構造が必要になる。
今は完全に無駄でしかないが、右辺が複雑になってくると効いてくるはず。</p><p>4 files changed, 160 insertions(+), 32 deletions(-)</p></li><li><p>commit 38805e39bc6b396625fe454fb84950f70fe85aa9<br>Date: Tue Oct 23 13:03:39 2018 +0900</p><p>Create README.md</p><p>1 file changed, 7 insertions(+)</p></li><li><p>commit 2d8b704e6e76f36edcac1e4c69639c0d0c33c5db<br>Date: Tue Oct 23 15:58:25 2018 +0900</p><p>Add &lsquo;&lt;&rsquo; and &lsquo;&gt;&rsquo;</p><p><a href=http://softwaretechnique.jp/OS_Development/Tips/IA32_Instructions/SETcc.html>Tips　IA32（x86）命令一覧　Sから始まる命令　SETcc命令</a><br><a href=https://en.wikipedia.org/wiki/Sign_extension>Sign extension - Wikipedia</a><br><a href=https://ja.wikibooks.org/wiki/X86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9/x86%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3#EFLAGS%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF>X86アセンブラ/x86アーキテクチャ - Wikibooks</a><br><a href=https://docs.oracle.com/cd/E19120-01/open.solaris/817-5477/eoizi/index.html>Bit and Byte Instructions (x86 Assembly Language Reference Manual)</a></p><p>ここで8ビットのレジスタを扱うことになるとは思わなかった。
なんでこんな仕様になっているんだろうか。
なにか都合のいいときがあるのだろうか、それとも単に歴史的経緯的なアレだろうか。</p><p>6 files changed, 100 insertions(+), 14 deletions(-)</p></li><li><p>commit 7d30caf9e43238425a10149466f71db50856cda2<br>Date: Tue Oct 23 18:53:52 2018 +0900</p><p>Add &ldquo;for&rdquo;</p><p>for文は使用頻度の割に複雑すぎると思う。
そろそろ吐かれるコードを読むのが困難になってきた。
少し前の時点でフィボナッチ数を計算できるようになってたみたいで、for文そっちのけで喜んでた。
既に作ってる時点で想定してなかったようなコードがコンパイルできる段階に来ていたようだ。
いよいよコンパイラとしての力が強くなってきた感じでテンションが上がる。</p><p>4 files changed, 72 insertions(+), 43 deletions(-)</p></li><li><p>commit c8179dce9ad2c4744e4295a5bd1fe1a26bd6f36a<br>Date: Wed Oct 24 08:19:26 2018 +0900</p><p>Add compound statement</p><p>3 files changed, 22 insertions(+), 13 deletions(-)</p></li><li><p>commit 40c5a15eb5ee5f70e178c660b0f0b9ce6d8cfa43<br>Date: Wed Oct 24 10:16:51 2018 +0900</p><p>Make variable definition explicit</p><p>型が出現してついに完全なCのコード、
つまり普通のCコンパイラがコンパイルしているコードがコンパイルできるようになった。</p><p>4 files changed, 81 insertions(+), 57 deletions(-)</p></li><li><p>commit d20a36d5639b476cfdcd04ead473808cd76cf0a2<br>Date: Wed Oct 24 15:18:34 2018 +0900</p><p>Add variable initializer</p><p>さまざまな文が書けるようになり、出力されるアセンブリも長くなってきた。
少しでも読みやすくなるように余分な改行を入れてみたりしたがそれでもつらい。
そもそも縦に長過ぎて大量にスクロールしなければならないのもつらい。
出力されたアセンブリを読むことによるデバッグがどんどん難しくなっていく。
まあだからこそコンパイラが必要とされるわけだが。</p><p>4 files changed, 24 insertions(+), 5 deletions(-)</p></li><li><p>commit 1b0b2608d4d6d2aef940c73f963af6a6c85179d0<br>Date: Wed Oct 24 16:24:19 2018 +0900</p><p>Allow declarator in the &ldquo;for&rdquo; initializer</p><p>5 files changed, 68 insertions(+), 32 deletions(-)</p></li><li><p>commit 05688d31edec387cac90a1adb9f5604e37821f36<br>Date: Wed Oct 24 17:39:30 2018 +0900</p><p>Simplify</p><p>2 files changed, 12 insertions(+), 16 deletions(-)</p></li><li><p>commit f15c1f5e105000f9c40467cf1a8566228ba6c618<br>Date: Fri Oct 26 16:55:20 2018 +0900</p><p>Add sema.d</p><p>変数のアドレスやスタック領域の大きさを計算する処理をgen_ir.dから分離。
変なふうにバグらせて最初から書き直したりした。</p><p>5 files changed, 171 insertions(+), 87 deletions(-)</p></li><li><p>commit 65c706190d62bbd9dea3c65ce234150cc09f1d61<br>Date: Sat Oct 27 22:30:45 2018 +0900</p><p>Add pointer</p><p>6 files changed, 141 insertions(+), 63 deletions(-)</p></li><li><p>commit 0e5fdb12c8015c7676a9cf94690df64dcdce87e0<br>Date: Sun Oct 28 15:12:03 2018 +0900</p><p>Add <pointer>+ <number>and <pointer>- <number></p><p>4 files changed, 79 insertions(+), 8 deletions(-)</p></li><li><p>commit 4cfc89551e1e76e7e719c41e9d7fbbf1c03c37f1<br>Date: Thu Nov 1 19:43:55 2018 +0900</p><p>Decay &ldquo;array of T&rdquo; to &ldquo;pointer to T&rdquo;</p><p><a href=http://rabbitfoot141.hatenablog.com/entry/2016/11/14/153101>gdbを使ってコアダンプの原因を解析 - それが僕には楽しかったんです。</a><br><a href=https://wiki.archlinux.jp/index.php/%E3%82%B3%E3%82%A2%E3%83%80%E3%83%B3%E3%83%97>コアダンプ - ArchWiki</a><br><a href=https://dlang.org/articles/ctod.html>Programming in D for C Programmers - D Programming Language</a></p><p>ついに配列らしきものが登場する。
だんだんポインタ操作がややこしくなってきて、セグフォに何度も遭遇するようになった。
クラスは常に参照なので、クラスを使えばポインタはとりあえずコード中から消える。
しかしそれでもやはりセグフォは出るのである。
一度構造体をすべてクラスに置き換えてみたが、ポインタを書かなくていいこと以外にメリットがなかったので戻した。</p><p>ここでコアダンプの読み方を習得した。
そのおかげで、苦節3日（途中カゼで寝込んだりした）、ようやくこのコミットができる。
gdbを使いこなせればコアダンプだって普通のエラーと変わらないのだ。</p><p>定数畳み込みの具体的実装が自然と頭に湧いてきて感動した。
今コンパイラ内部で生成されているASTを使えばとても簡単にできてしまう。
ただ、もうしばらくは9ccのコミットログに沿っていこうと思う。</p><p>コンパイラ作成を通して、久しぶりにプログラミングに関する知識が爆発的に増えている。
これは他人に薦めたくなる。
みんなCコンパイラを作ろう。</p><p>8 files changed, 170 insertions(+), 65 deletions(-)</p></li><li><p>commit 251f8457607abe4ad8d48cba14bb32b7dc8e73a0<br>Date: Fri Nov 2 14:47:00 2018 +0900</p><p>Simplify Enums</p><p><a href=https://www.sigbus.info/compilerbook/>低レイヤを知りたい人のための Cコンパイラ作成入門</a></p><p>Cコンパイラ本が一部公開された。
<code>NUM=256</code>の意図がようやくわかった。
しかしasciiの範囲内のトークンにも勝手に名前をつけているので今更真似しても意味がない。</p><p>4 files changed, 47 insertions(+), 27 deletions(-)</p></li><li><p>commit 3c53d50cf96a276c21ceb64c07bb624222c2b5d5<br>Date: Fri Nov 2 15:00:16 2018 +0900</p><p>Add &ldquo;&amp;&rdquo; (address-of) operator</p><p>4 files changed, 27 insertions(+), 14 deletions(-)</p></li><li><p>commit 2a0482fc08d9081a322a3e7165649430c89db7a8<br>Date: Fri Nov 2 15:17:56 2018 +0900</p><p>Do not use struct assignment</p><p>1 file changed, 43 insertions(+), 47 deletions(-)</p></li><li><p>commit eed148b8d64f6860d75875c8e1b97073f885f101<br>Date: Fri Nov 2 15:35:53 2018 +0900</p><p>Add &ldquo;sizeof&rdquo;</p><p>4 files changed, 24 insertions(+), 2 deletions(-)</p></li><li><p>commit 989d001306becde7f29b05f82b77f8e93cfbe896<br>Date: Fri Nov 2 15:41:48 2018 +0900</p><p>Move lvalue check to sema.c</p><p>2 files changed, 4 insertions(+), 2 deletions(-)</p></li><li><p>commit e2502b73a8169542d530fa821adf751c70693f6a<br>Date: Fri Nov 2 17:25:46 2018 +0900</p><p>Add &ldquo;[]&rdquo; operator</p><p>2 files changed, 56 insertions(+), 24 deletions(-)</p></li><li><p>commit d1345402ccd186ca993f35e0a18d7b877add357b<br>Date: Fri Nov 2 18:18:25 2018 +0900</p><p>Simplify</p><p>どうもフォーマッターにバグがありそう。
コメントの漢字が文字化けしている。
英語で書けばいい問題だが、ただのコピペにしないためにも9ccとは違う言語を使いたい。
dfmtは以前にも機能追加をしたことがあるので、これもそのうち修正しに行きたい。</p><p>1 file changed, 33 insertions(+), 79 deletions(-)</p></li><li><p>commit 1ba782b1b82b7b39290adebf6495522297111c34<br>Date: Sat Nov 3 08:43:51 2018 +0900</p><p>Parallelize test</p><p>テストの数が多くなってきたので開発環境の豊富なコアを活用できるようにした。
めっちゃ速くなってうれしい。
ただ9ccのコミットログを見る限り数日のうちに不要になりそう。
しかしだからこそ雑に作っても大丈夫なのである（言い訳）</p><p>1 file changed, 58 insertions(+), 69 deletions(-)</p></li><li><p>commit 7fb09d5c50e71f9b8d29f23df09287d5e5fe4972<br>Date: Sat Nov 3 15:10:34 2018 +0900</p><p>Add char type</p><p>7 files changed, 99 insertions(+), 23 deletions(-)</p></li><li><p>commit 2fb453cd84f89e89c2e12820bc81d9a8f460b0d3<br>Date: Sun Nov 4 11:36:48 2018 +0900</p><p>Add string literal</p><p><a href=http://www.ertl.jp/~takayuki/readings/info/no02.html>セクションとか.textとか</a></p><p>hello worldが動いた。
hello worldが動いた！</p><p>8 files changed, 181 insertions(+), 47 deletions(-)</p></li><li><p>commit a75e99629cd991d1ba5f9a1fce5ac4550ef70fd7<br>Date: Sun Nov 4 18:33:34 2018 +0900</p><p>Fix array operator</p><p>2 files changed, 2 insertions(+), 2 deletions(-)</p></li><li><p>commit d3836db113bcc92ccb9953a195978ee04585017e<br>Date: Sun Nov 4 18:44:13 2018 +0900</p><p>Add examples/nqueen.c</p><p>1 file changed, 47 insertions(+)</p></li><li><p>commit 3b6a32180b473400f8cbdf3e62c2e41c18e0ddf1<br>Date: Tue Nov 6 15:13:01 2018 +0900</p><p>Better handling of string literals</p><p><a href=https://www.mm2d.net/main/prog/c/printf_format-01.html>出力書式のまとめ 変換指定子 - printf出力書式まとめ - 碧色工房</a><br><a href=http://www.swlab.cs.okayama-u.ac.jp/~nom/lect/p3/what-is-directive.html>アセンブラ指令 - 2018年度 システムプログラミング</a></p><p>4 files changed, 76 insertions(+), 46 deletions(-)</p></li><li><p>commit 312a283cabd8bf422b7236b3a9e132e4034baad6<br>Date: Tue Nov 6 18:00:00 2018 +0900</p><p>Implement block scope</p><p>2 files changed, 66 insertions(+), 33 deletions(-)</p></li><li><p>commit 3d0ca942d75ef729be6e5d4a8ff37d3d0d26ccf1<br>Date: Tue Nov 6 18:18:05 2018 +0900</p><p>Simplify</p><p>1 file changed, 28 insertions(+), 40 deletions(-)</p></li><li><p>commit 7da653795b536fc919f127e95374c149d4fd8d24<br>Date: Thu Nov 8 13:22:37 2018 +0900</p><p>Add global variable</p><p>7 files changed, 152 insertions(+), 94 deletions(-)</p></li><li><p>commit c919586148594089ed167af4667aa2674bb36d35<br>Date: Thu Nov 8 13:26:09 2018 +0900</p><p>Add string escape sequences</p><p>1 file changed, 61 insertions(+), 12 deletions(-)</p></li><li><p>commit c438948d2972a1a06a636887cfb813bfe9d53222<br>Date: Fri Nov 9 16:31:30 2018 +0900</p><p>Add &ldquo;==&rdquo; and &ldquo;!=&rdquo;</p><p>6 files changed, 66 insertions(+), 11 deletions(-)</p></li><li><p>commit 7547cf07f3f8820e10834acea56de3c2cb0d0633<br>Date: Sun Nov 11 19:34:56 2018 +0900</p><p>Make consume() and expect() ad-hoc polymorphic</p><p>1 file changed, 27 insertions(+), 17 deletions(-)</p></li><li><p>commit 7920b0987cab8c6aabe41064815de8032703de07<br>Date: Sun Nov 11 22:22:30 2018 +0900</p><p>Add do ~ while loop</p><p>わりと簡単にできた。
IF中間表現とje命令が現れた。
if文のときに出てこなかったのにここで出てくるとは……</p><p>6 files changed, 41 insertions(+), 1 deletion(-)</p></li><li><p>commit 7a3f22e6c89569545a69459f7025104fd81fa5ce<br>Date: Thu Nov 15 13:19:54 2018 +0900</p><p>Add &ldquo;extern&rdquo;</p><p>D言語くん Advent Calendar 5日目の記事がだいたい書き終わったので再開。
どうも自分に複数のプロジェクトを同時進行でするパワーはないらしい。</p><p>5 files changed, 24 insertions(+), 8 deletions(-)</p></li><li><p>commit 7f933f641f964fea80849f1af98db699364daea9<br>Date: Thu Nov 15 16:52:38 2018 +0900</p><p>Add expression statement</p><p>9ccでグローバル変数になっていた通し番号用変数を引数として渡すようにしていたのだが、
あまりに煩雑になってきたので元に戻した。
こういうことをやるならしっかり考えてからでないといけない。</p><p>4 files changed, 93 insertions(+), 48 deletions(-)</p></li><li><p>commit c860ad98d08fa2a3a99a8d1b146f6f915de241ff<br>Date: Thu Nov 15 19:28:04 2018 +0900</p><p>Fix escape()</p><p>1 file changed, 4 insertions(+), 2 deletions(-)</p></li><li><p>commit 0e4ed87fe3f561a5dbf84de345f0b629a7a74872<br>Date: Thu Nov 15 20:25:07 2018 +0900</p><p>Rewrite tests in shell in C</p><p>9ccのコードにはけっこうしょうもない抜けがあったりする。
プロでもこんなミスをしょっちゅうするのかと思うと気が楽になる。
d9ccは何も考えずに書き写しているものではないので、
こちらのほうには抜けは継承されていない。
しかし、当然ながら、d9ccのほうで生まれた新しい抜けも結構あった。</p><p>6 files changed, 120 insertions(+), 154 deletions(-)</p></li><li><p>commit 06d7c1e429fd85e7405ac593661dd680425a3364<br>Date: Sat Nov 17 17:10:10 2018 +0900</p><p>Add while loop</p><p>なんかうまいことできそうな気がして9ccのほうを見ずにやってみていた。
新しいノードを追加しようとしたが、
9ccのほうを見てみたら単にforループに変換して済ませていてヘコんだ。</p><p>でもエラー行の表示はオリジナルだよ！自分すごい！！</p><p>6 files changed, 49 insertions(+), 12 deletions(-)</p></li><li><p>commit 85cbf2a88d9cddf43128c3b286b73c2373c2b812<br>Date: Sat Nov 17 17:25:21 2018 +0900</p><p>Allow empty statement</p><p>これは見ないで同じコードが書けたぞ！どうだ！やったぜ！</p><p>2 files changed, 6 insertions(+), 1 deletion(-)</p></li><li><p>commit d27b79c926132f1e30e8cbd0305a1ee9c9379dec<br>Date: Sat Nov 17 20:17:14 2018 +0900</p><p>Add char literal</p><p>このコンパイラはDで書いているので、セルフホストというわかりやすいマイルストーンがない。
なので、どこで終わりにするかを自分で決めなければならない。</p><p>とりあえず手近なマイルストーンとしては、
しばらくあとにソースをファイルから読み込むように変更するコミットがあるが、
その後もさまざまな機能追加が続くし、ちょっと手近過ぎる気もする。
その後になにかキリのいい場所がないかコミットメッセージを読んでみるも、
9ccのほうもやめどきに到達していないからコミットが続いているのであって、
やはりやめどきは見つからない。</p><p>そこで、D言語 Advent Calendar の締切がくるまでは続けることにした。
これもまたAC駆動開発……</p><p>2 files changed, 64 insertions(+), 28 deletions(-)</p></li><li><p>commit 27bbaf9cd1aaee06f282b5eeb6d3786f6cc63ebe<br>Date: Sat Nov 17 20:54:59 2018 +0900</p><p>Simplify</p><p>1 file changed, 17 insertions(+), 3 deletions(-)</p></li><li><p>commit 92bfc100e569aaba57aed4af7166e43ee2bbce39<br>Date: Sat Nov 17 21:24:11 2018 +0900</p><p>Add single-line and block comments</p><p>2 files changed, 57 insertions(+), 24 deletions(-)</p></li><li><p>commit d7421265a81324ae85183ab647d4d4bb822cceff<br>Date: Sat Nov 17 21:31:22 2018 +0900</p><p>Rename a variable</p><p>4 files changed, 7 insertions(+), 7 deletions(-)</p></li><li><p>commit a0c65cc38bf1b52498384d0fad622ca3c6623a37<br>Date: Sat Nov 17 21:53:36 2018 +0900</p><p>Remove IRType.SUB_IMM and add IRType.BPREL</p><p><a href=https://ja.wikibooks.org/wiki/X86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9/%E3%83%87%E3%83%BC%E3%82%BF%E8%BB%A2%E9%80%81%E5%91%BD%E4%BB%A4#%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E8%A8%88%E7%AE%97%E5%91%BD%E4%BB%A4>X86アセンブラ/データ転送命令 - Wikibooks</a><br><a href=http://suu-g.hateblo.jp/entry/20080505/1210012224>lealについて - suu-g&rsquo;s diary</a></p><p>srcオペランドでめっちゃ計算できる。
アセンブリを手書きする時は便利そう。
速度面でも1命令で済ませたほうが良かったりするんだろうか。
これがCISCというやつか……</p><p>2 files changed, 7 insertions(+), 9 deletions(-)</p></li><li><p>commit 5dab8368858cdea8d657bf8289d6cacd8cdac7b8<br>Date: Sun Nov 18 00:08:39 2018 +0900</p><p>Align stack data members</p><p><a href=https://tepp91.github.io/contents/cpp/adjust-alignment.html>アライメントを考慮したサイズの取得</a><br><a href=https://alpha-netzilla.blogspot.com/2013/01/bit.html>Blog Alpha Networking: ビット(bit)演算操作の覚え書き</a><br><a href=http://uchan.hateblo.jp/entry/2018/02/16/232029>x86-64 モードのプログラミングではスタックのアライメントに気を付けよう - uchan note</a></p><p>3 files changed, 29 insertions(+), 2 deletions(-)</p></li><li><p>commit 255a4d30b11dc45b70fd8d9c34ef360193336995<br>Date: Thu Nov 22 13:13:32 2018 +0900</p><p>Add _Alignof</p><p>4 files changed, 25 insertions(+), 4 deletions(-)</p></li><li><p>commit 8a867d08f1af0cd4acab7fe8f6aca4609725c93b<br>Date: Thu Nov 22 13:23:07 2018 +0900</p><p>Split gen_ir.d into gen_ir.d and irdump.d</p><p>5 files changed, 110 insertions(+), 103 deletions(-)</p></li><li><p>commit 5201f1c8870d09cd8a96e91b2b4bbbda5e26b97d<br>Date: Thu Nov 22 13:38:19 2018 +0900</p><p>Simplify</p><p>1 file changed, 30 insertions(+), 48 deletions(-)</p></li><li><p>commit da0846a4dd600b19a385077a2f96c10b092a1463<br>Date: Thu Nov 22 13:48:24 2018 +0900</p><p>Simplify</p><p>1 file changed, 9 insertions(+), 9 deletions(-)</p></li><li><p>commit 7b6675a71ea8dc8a2141b165eb59737e283ba0fc<br>Date: Thu Nov 22 14:00:22 2018 +0900</p><p>Take filename instead of code string as a command line argument</p><p>ファイル名を受け取って文字列として変数に入れるだけの処理。
さすがにD言語だとコード量が少なくて済む。</p><p>2 files changed, 9 insertions(+), 6 deletions(-)</p></li><li><p>commit 7680199f5b51b292d22dc64b8dd7269341ee4b6d<br>Date: Thu Nov 22 15:39:01 2018 +0900</p><p>Fix: Use isWhite() instead of isSpace()</p><p>1 file changed, 3 insertions(+), 3 deletions(-)</p></li><li><p>commit c48fa192e8f86fc493fe8cdabdeb43eed839347e<br>Date: Sat Nov 24 14:18:31 2018 +0900</p><p>Add -dump-ast options</p><p>ASTをgraphvizのdot形式で出力するオリジナル機能。
いまさらデバッグ目的で使うことはないが、
やっぱり何が起こっているか見てわかるとおもしろい。</p><p>3 files changed, 451 insertions(+), 10 deletions(-)</p></li></ul></article><footer><h2><a href=/tags/dlang>#dlang</a>
君もDでx86_64向けCコンパイラを書こう</h2><p><time>2018-12-11</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/assembly>#assembly</a> <a href=/tags/tech>#tech</a> <a href=/tags/advent-calendar>#advent-calendar</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>