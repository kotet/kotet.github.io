<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="内向けの記事を書く。 正規表現の問題の解説記事である。 解説記事と言いつつ複数の解を提示してしかも結局どれも正解ではないというとんでもない結論に"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.02c91f0bdf54d569f6c715f0a345bf32b55cd4d3ac11e0b98fec7ad1e614c151.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#regexp 同じ文字の繰り返しが3回続く単語にマッチする正規表現 - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2018/05/grep-literacy/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#regexp 同じ文字の繰り返しが3回続く単語にマッチする正規表現 - Kotet's Personal Blog"><meta name=og:description content="内向けの記事を書く。 正規表現の問題の解説記事である。 解説記事と言いつつ複数の解を提示してしかも結局どれも正解ではないというとんでもない結論に"><meta name=twitter:image content=https://blog.kotet.jp/img/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2018/05/grep-literacy/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.55.2"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><span class=text-up>ABOUT</span><a href=/about title=about><svg width="22" height="22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="info" transform="translate(-1.000000, -1.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M12 23C5.92486775 23 1 18.0751322 1 12 1 5.92486775 5.92486775 1 12 1 18.0751322 1 23 5.92486775 23 12 23 18.0751322 18.0751322 23 12 23zm0-2C16.9705627 21 21 16.9705627 21 12 21 7.02943725 16.9705627 3 12 3 7.02943725 3 3 7.02943725 3 12 3 16.9705627 7.02943725 21 12 21zM13.0036109 13.9983464H14.0029544v2h-4v-2h1v-2h-1V9.99834639h3.0006565V13.9983464zM12.0003283 8.99834639C11.4478622 8.99834639 11 8.55063114 11 7.99834639 11 7.44606164 11.4478622 6.99834639 12.0003283 6.99834639 12.5527943 6.99834639 13.0006565 7.44606164 13.0006565 7.99834639c0 .5522847500000001-.44786219999999943 1-1.0003282000000002 1z" id="Oval-17" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>DOWNLOAD</span><a href=/products title=download><svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="download" transform="translate(-2.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M22 16v4C22 21.1045695 21.1045695 22 20 22H4C2.8954305 22 2 21.1045695 2 20V16H4v4H20V16h2zm-9-3.4142136L16.2928932 9.29289322 17.7071068 10.7071068 12 16.4142136 6.29289322 10.7071068 7.70710678 9.29289322 11 12.5857864V2h2V12.5857864z" id="Combined-Shape" fill="#000"/></g></g></svg></a></li><li><span class=text-up>TAG</span><a href=/tags title=tag><svg width="22" height="14" viewBox="0 0 22 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="tag" transform="translate(-1.000000, -5.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M6.53518376 5H21C22.1045695 5 23 5.8954305 23 7V17C23 18.1045695 22.1045695 19 21 19H6.53518376C5.86647738 19 5.24201473 18.6657977 4.87108317 18.1094004L1.16794971 12.5547002C.944016765 12.2188008.944016765 11.7811992 1.16794971 11.4452998L4.87108317 5.89059961C5.24201473 5.33420227 5.86647738 5 6.53518376 5zM3.20185043 12l3.33333333 5H21V7H6.53518376L3.20185043 12zM7 13C6.44771525 13 6 12.5522847 6 12 6 11.4477153 6.44771525 11 7 11 7.55228475 11 8 11.4477153 8 12 8 12.5522847 7.55228475 13 7 13z" id="Rectangle-29" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>PODCAST</span><a href=https://podcast.kotet.jp title=podcast><svg width="22" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="broadcasting" transform="translate(-1.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M9.38742589 20 8.72075922 22H6.61257411L9.89881747 12.1412699C9.34410225 11.5968755 9 10.8386225 9 10 9 8.34314575 10.3431458 7 12 7 13.6568542 7 15 8.34314575 15 10 15 10.8386225 14.6558977 11.5968755 14.1011825 12.1412699L17.3874259 22H15.2792408L14.6125741 20H9.38742589zM10.7207592 16 10.0540926 18H13.9459074L13.2792408 16H10.7207592zM11.3874259 14H12.6125741L12.2750928 12.987556C12.1844984 12.9957918 12.0927406 13 12 13 11.9072594 13 11.8155016 12.9957918 11.7249072 12.987556L11.3874259 14zM12 11C12.5522847 11 13 10.5522847 13 10 13 9.44771525 12.5522847 9 12 9 11.4477153 9 11 9.44771525 11 10 11 10.5522847 11.4477153 11 12 11zm8.108743-8.43301443C21.9041909 4.52460368 23 7.13433188 23 10 23 12.8656681 21.9041909 15.4753963 20.108743 17.4330144L18.6344261 16.0815573C20.103429 14.4798697 21 12.3446376 21 10 21 7.65536245 20.103429 5.52013028 18.6344261 3.91844274L20.108743 2.56698557zM17.1601092 5.26989991C18.302667 6.51565689 19 8.17639301 19 10 19 11.823607 18.302667 13.4843431 17.1601092 14.7301001L15.6857923 13.3786429C16.501905 12.4888165 17 11.3025764 17 10 17 8.69742358 16.501905 7.51118349 15.6857923 6.62135708L17.1601092 5.26989991zM3.89125699 2.56665655 5.3655739 3.91811372C3.89657104 5.51980126 3 7.65503343 3 9.99967098 3 12.3443085 3.89657104 14.4795407 5.3655739 16.0812282L3.89125699 17.4326854C2.09580905 15.4750673 1 12.8653391 1 9.99967098 1 7.13400286 2.09580905 4.52427466 3.89125699 2.56665655zM6.83989081 5.26957089 8.31420772 6.62102806C7.49809502 7.51085447 7 8.69709456 7 9.99967098 7 11.3022474 7.49809502 12.4884875 8.31420772 13.3783139L6.83989081 14.7297711C5.69733303 13.4840141 5 11.823278 5 9.99967098 5 8.17606399 5.69733303 6.51532787 6.83989081 5.26957089z" id="Combined-Shape" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-up>FEED</span><a href=/index.xml title=feed><svg width="22" height="18" viewBox="6 8 .5 10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs><path d="M1 21V19C2.1045695 19 3 19.8954305 3 21H1zm6 0H5C5 18.790861 3.209139 17 1 17V15C4.3137085 15 7 17.6862915 7 21zm4 0H9C9 16.581722 5.418278 13 1 13V11C6.5228475 11 11 15.4771525 11 21z" id="path-1"/></defs><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="cast" transform="translate(-1.000000, -3.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Combined-Shape" fill="#000" fill-rule="nonzero" xlink:href="#path-1"/></g></g></svg></a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/regexp>#regexp</a>
同じ文字の繰り返しが3回続く単語にマッチする正規表現</h2><p><time>2018-05-10</time>
<a href=/tags/regexp>#regexp</a> <a href=/tags/tech>#tech</a> <a href=/tags/log>#log</a></p><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#問題文>問題文</a></li><li><a href=#複数の解釈>複数の解釈</a><ul><li><a href=#1-kotetの解釈-agreeeth>1: Kotetの解釈 - &ldquo;agreeeth&rdquo;</a><ul><li><a href=#ドット>ドット ( <code>.</code> )</a></li><li><a href=#カッコ>カッコ ( <code>()</code> )</a></li><li><a href=#波括弧>波括弧 ( <code>{}</code> )</a></li><li><a href=#不具合-4文字以上の繰り返しは不正か>不具合: 4文字以上の繰り返しは不正か?</a></li></ul></li><li><a href=#2-jjjohn-sonの解釈-bookkeep>2: @jjjohn_sonの解釈 - &ldquo;bookkeep&rdquo;</a><ul><li><a href=#4文字の連続した文字が2つの連続として扱われる不具合>4文字の連続した文字が2つの連続として扱われる不具合</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav></aside></header><article><p>内向けの記事を書く。
正規表現の問題の解説記事である。
解説記事と言いつつ複数の解を提示してしかも結局どれも正解ではないというとんでもない結論に達してしまった……</p><p><strong>追記:</strong> 最近このページに来る人が多いので付け加えておくのだが、
これはあくまで問題として出されたから正規表現を使っているのだ。
ここまでのことを正規表現で行うと可読性も落ちるし、バグがあっても気づきにくい。
自分なら正規表現を使わずに普通に判定用のプログラムを書く。</p><h3 id=問題文>問題文</h3><p>以下の単語にマッチする正規表現を書いてgrepで使うという問題である。</p><blockquote><p>同じ文字の繰り返しが3回続く単語(2回であればballoon, coffee, succeedなど多数存在する)</p></blockquote><p>この問題には複数の解釈があり、それぞれの解釈ごとにまた複数の解法がある。
なお、この記事内では問題のファイルではなくKotetのPCの<code>/usr/share/dict/cracklib-small</code>の中身に対してgrepをかけているので注意である。</p><h3 id=複数の解釈>複数の解釈</h3><h4 id=1-kotetの解釈-agreeeth>1: Kotetの解釈 - &ldquo;agreeeth&rdquo;</h4><p>同じ文字が3回ということで自分が考えたもの。
自分はすでにこの解釈で提出してしまっているのでもし出題意図が違っても修正できない。</p><p>ここでは後方参照という概念が必要になる。
まず自分の書いた正規表現を書いておく。</p><pre><code>(.)\1{2}
</code></pre><p>以降構成要素を一つづつ取り上げていく。</p><h5 id=ドット>ドット ( <code>.</code> )</h5><p>&ldquo;<code>.</code>&rdquo; は任意の1文字にマッチする。
<code>ABC</code>という文字列の場合<code>A</code>と<code>B</code>と<code>C</code>がマッチする。</p><h5 id=カッコ>カッコ ( <code>()</code> )</h5><p>&ldquo;<code>()</code>&ldquo;はグループ化をする。
例えば<code>(AB)</code>という正規表現は<code>ABC</code>の<code>AB</code>の部分にマッチする。
また、ここでマッチしたパターンをあとで再利用できる。
これを後方参照という。</p><p>たとえば<code>(.)\1</code>という正規表現を考えてみる。
まず最初に&rdquo;<code>.</code>&ldquo;があるので任意の1文字にマッチする。
<code>ABC</code>の場合<code>A</code>である。
そしてこのマッチ結果が1から始まる番号の振られたバッファに保存される。
1番目のバッファに<code>A</code>が保存されたということになる。
バッファは<code>\n</code>(<code>n</code>はバッファの番号)で参照することができ、マッチ結果を普通に書いたのと同じように使える。
<code>ABC</code>の<code>A</code>まで読み込んだ時点で<code>\1</code>は<code>(A)</code>と同じになり、正規表現は<code>(A)(A)</code>であるかのように動き、したがって2文字目も<code>A</code>であるか調べるようになる。
<code>ABC</code>の場合2文字目は<code>B</code>なのでマッチしない。
以降も<code>(B)(B)</code>、<code>(C)(C)</code>と続き、結局この正規表現は<code>ABC</code>のどの部分ともマッチしない。
ここまでくればおわかりだろう……というほど自分の説明能力に自身がないが、つまり<code>(.)\1</code>は同じ文字が2回続いた場合にマッチする正規表現である。
たぶんもっとわかりやすい説明がたくさんあるのでわからなかったら後方参照でググってみてほしい。</p><p>ここまでの知識でも問題を解くことができる。
先程の例に1つ継ぎ足して<code>(.)\1\1</code>とすれば答えである。
これは拡張正規表現なので <code>-E</code> オプションをつけて、さらに正規表現をクオート( <code>'</code> )で囲っておくと確実である。</p><pre><code class=language-console>$ grep -E '(.)\1\1' &lt; /usr/share/dict/cracklib-small
aaa
aaas
death666
devil666
gsxr1000
hal9000
ieee
iii
postov1000
satan666
viii
</code></pre><h5 id=波括弧>波括弧 ( <code>{}</code> )</h5><p>&ldquo;<code>{}</code>&rdquo; は &ldquo;<code>*</code>&rdquo; や &ldquo;<code>+</code>&rdquo; のように繰り返しを表す。
&ldquo;<code>*</code>&rdquo; や &ldquo;<code>+</code>&rdquo; はそれぞれ0回以上と1回以上の繰り返しにマッチするが (たとえば<code>A+</code>は<code>A</code>、<code>AA</code>、<code>AAA</code>などにマッチする) 、<code>{}</code>を使えば繰り返しの回数を細かく指定できる。
<code>{2}</code>はちょうど2回、<code>{2,}</code>は2回以上、<code>{2,3}</code>は2回以上3回以下を意味する。</p><p>ここまでの要素をすべて使ったのが自分の書いた正規表現である。
まず任意の文字列にマッチし、その後最初にマッチしたパターンが2回続く、という意味になる。
繰り返しは2回同じことを書くのが嫌で使ったが、むしろ文字数は増えているし再利用するような正規表現でもないので素直に2回書いたほうが良かったかもしれない。</p><pre><code class=language-console>$ grep -E '(.)\1{2}' &lt; /usr/share/dict/cracklib-small
</code></pre><p>ちなみに拡張正規表現を使わないとこんな感じになる。
バックスラッシュがいっぱいで読みにくいので素直に <code>-E</code> をつけたほうがいいと思う。</p><pre><code class=language-console>$ grep '\(.\)\1\{2\}' &lt; /usr/share/dict/cracklib-small
</code></pre><h5 id=不具合-4文字以上の繰り返しは不正か>不具合: 4文字以上の繰り返しは不正か?</h5><p>この正規表現は3文字の繰り返しがあったらそれ以上先は見ないので、<code>aaaa</code>などの4文字以上の繰り返しの行も残ってしまう。
これを回避できないかちょっと試してみたが、どうも思うようにいかない。
だれか正規表現に詳しい人がいたら教えてほしい。</p><p><strong>追記:</strong> 上記の問題を解決することができたのでここに書く。
解決はできたがこれは拡張正規表現ではなくPerl互換正規表現(PCRE)である。
仕組みを知りたい人は否定先読みでググってほしい。
やたら複雑になって可読性が低下した上に、たぶんこういう答えは求められていない。</p><pre><code class=language-console>$ cat test.txt 
a
aa
aaa
aaaa
abbb
abbbb
aaab
aaaab
abbbc
abbbbc
aaaabbb
$ grep -P '(^|(.)(?!\2))(.)\3{2}(?!\3)(.|$)' &lt; test.txt
aaa
abbb
aaab
abbbc
aaaabbb
</code></pre><h4 id=2-jjjohn-sonの解釈-bookkeep>2: @jjjohn_sonの解釈 - &ldquo;bookkeep&rdquo;</h4><p>「繰り返し」が3回続く、という解釈。
これに基づいた回答を見るまで全くこの解釈ができることに気づかなかった。</p><p>こちらも同じ要素を使って解くことができる。
グループ化を多重に使うのでどのカッコが何番かちょっとわかりづらい。
どうも開きカッコが出現した順に番号が振られるようだ。
一番外側のカッコ(1番)は単にグループ化のためだけに使っているもので、後方参照は内側のカッコ(2番)でのみ使われていることに注意である。</p><p>この解釈の場合繰り返しの文字数については言及されていない(<code>aaabbbbcc</code>などもマッチする)ということになるのでそれも考慮した正規表現を書こうとしてみる。</p><pre><code class=language-console>$ grep -E '((.)\2+){3}' &lt; /usr/share/dict/cracklib-small
bookkeep
bookkeeper
bookkeeper's
bookkeepers
bookkeeping
</code></pre><h5 id=4文字の連続した文字が2つの連続として扱われる不具合>4文字の連続した文字が2つの連続として扱われる不具合</h5><p>じつはこれだと<code>aabbbb</code>などでもマッチしてしまう。
それを回避するバージョンも今の所思いついていないので誰かできたら教えてほしい。</p></article><footer><h2><a href=/tags/regexp>#regexp</a>
同じ文字の繰り返しが3回続く単語にマッチする正規表現</h2><p><time>2018-05-10</time>
<a href=/tags/regexp>#regexp</a> <a href=/tags/tech>#tech</a> <a href=/tags/log>#log</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>