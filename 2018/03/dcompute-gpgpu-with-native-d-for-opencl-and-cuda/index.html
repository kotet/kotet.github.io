<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content=DComputeはGPUやその他アクセラレータを使う計算集約型コードのためにOpenCLやCUDA用のネイティブカーネルをDで書くことをサポートするフレームワークでありコンパイラ拡張です。><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.02c91f0bdf54d569f6c715f0a345bf32b55cd4d3ac11e0b98fec7ad1e614c151.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang DCompute:ネイティブDによるOpenCLやCUDAのGPGPU【翻訳】 - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2018/03/dcompute-gpgpu-with-native-d-for-opencl-and-cuda/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#dlang DCompute:ネイティブDによるOpenCLやCUDAのGPGPU【翻訳】 - Kotet's Personal Blog"><meta name=og:description content=DComputeはGPUやその他アクセラレータを使う計算集約型コードのためにOpenCLやCUDA用のネイティブカーネルをDで書くことをサポートするフレームワークでありコンパイラ拡張です。><meta name=twitter:image content=https://blog.kotet.jp/img/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2018/03/dcompute-gpgpu-with-native-d-for-opencl-and-cuda/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.55.2"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><span class=text-up>ABOUT</span><a href=/about title=about><svg width="22" height="22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="info" transform="translate(-1.000000, -1.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M12 23C5.92486775 23 1 18.0751322 1 12 1 5.92486775 5.92486775 1 12 1 18.0751322 1 23 5.92486775 23 12 23 18.0751322 18.0751322 23 12 23zm0-2C16.9705627 21 21 16.9705627 21 12 21 7.02943725 16.9705627 3 12 3 7.02943725 3 3 7.02943725 3 12 3 16.9705627 7.02943725 21 12 21zM13.0036109 13.9983464H14.0029544v2h-4v-2h1v-2h-1V9.99834639h3.0006565V13.9983464zM12.0003283 8.99834639C11.4478622 8.99834639 11 8.55063114 11 7.99834639 11 7.44606164 11.4478622 6.99834639 12.0003283 6.99834639 12.5527943 6.99834639 13.0006565 7.44606164 13.0006565 7.99834639c0 .5522847500000001-.44786219999999943 1-1.0003282000000002 1z" id="Oval-17" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>DOWNLOAD</span><a href=/products title=download><svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="download" transform="translate(-2.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M22 16v4C22 21.1045695 21.1045695 22 20 22H4C2.8954305 22 2 21.1045695 2 20V16H4v4H20V16h2zm-9-3.4142136L16.2928932 9.29289322 17.7071068 10.7071068 12 16.4142136 6.29289322 10.7071068 7.70710678 9.29289322 11 12.5857864V2h2V12.5857864z" id="Combined-Shape" fill="#000"/></g></g></svg></a></li><li><span class=text-up>TAG</span><a href=/tags title=tag><svg width="22" height="14" viewBox="0 0 22 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="tag" transform="translate(-1.000000, -5.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M6.53518376 5H21C22.1045695 5 23 5.8954305 23 7V17C23 18.1045695 22.1045695 19 21 19H6.53518376C5.86647738 19 5.24201473 18.6657977 4.87108317 18.1094004L1.16794971 12.5547002C.944016765 12.2188008.944016765 11.7811992 1.16794971 11.4452998L4.87108317 5.89059961C5.24201473 5.33420227 5.86647738 5 6.53518376 5zM3.20185043 12l3.33333333 5H21V7H6.53518376L3.20185043 12zM7 13C6.44771525 13 6 12.5522847 6 12 6 11.4477153 6.44771525 11 7 11 7.55228475 11 8 11.4477153 8 12 8 12.5522847 7.55228475 13 7 13z" id="Rectangle-29" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>PODCAST</span><a href=https://podcast.kotet.jp title=podcast><svg width="22" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="broadcasting" transform="translate(-1.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M9.38742589 20 8.72075922 22H6.61257411L9.89881747 12.1412699C9.34410225 11.5968755 9 10.8386225 9 10 9 8.34314575 10.3431458 7 12 7 13.6568542 7 15 8.34314575 15 10 15 10.8386225 14.6558977 11.5968755 14.1011825 12.1412699L17.3874259 22H15.2792408L14.6125741 20H9.38742589zM10.7207592 16 10.0540926 18H13.9459074L13.2792408 16H10.7207592zM11.3874259 14H12.6125741L12.2750928 12.987556C12.1844984 12.9957918 12.0927406 13 12 13 11.9072594 13 11.8155016 12.9957918 11.7249072 12.987556L11.3874259 14zM12 11C12.5522847 11 13 10.5522847 13 10 13 9.44771525 12.5522847 9 12 9 11.4477153 9 11 9.44771525 11 10 11 10.5522847 11.4477153 11 12 11zm8.108743-8.43301443C21.9041909 4.52460368 23 7.13433188 23 10 23 12.8656681 21.9041909 15.4753963 20.108743 17.4330144L18.6344261 16.0815573C20.103429 14.4798697 21 12.3446376 21 10 21 7.65536245 20.103429 5.52013028 18.6344261 3.91844274L20.108743 2.56698557zM17.1601092 5.26989991C18.302667 6.51565689 19 8.17639301 19 10 19 11.823607 18.302667 13.4843431 17.1601092 14.7301001L15.6857923 13.3786429C16.501905 12.4888165 17 11.3025764 17 10 17 8.69742358 16.501905 7.51118349 15.6857923 6.62135708L17.1601092 5.26989991zM3.89125699 2.56665655 5.3655739 3.91811372C3.89657104 5.51980126 3 7.65503343 3 9.99967098 3 12.3443085 3.89657104 14.4795407 5.3655739 16.0812282L3.89125699 17.4326854C2.09580905 15.4750673 1 12.8653391 1 9.99967098 1 7.13400286 2.09580905 4.52427466 3.89125699 2.56665655zM6.83989081 5.26957089 8.31420772 6.62102806C7.49809502 7.51085447 7 8.69709456 7 9.99967098 7 11.3022474 7.49809502 12.4884875 8.31420772 13.3783139L6.83989081 14.7297711C5.69733303 13.4840141 5 11.823278 5 9.99967098 5 8.17606399 5.69733303 6.51532787 6.83989081 5.26957089z" id="Combined-Shape" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-up>FEED</span><a href=/index.xml title=feed><svg width="22" height="18" viewBox="6 8 .5 10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs><path d="M1 21V19C2.1045695 19 3 19.8954305 3 21H1zm6 0H5C5 18.790861 3.209139 17 1 17V15C4.3137085 15 7 17.6862915 7 21zm4 0H9C9 16.581722 5.418278 13 1 13V11C6.5228475 11 11 15.4771525 11 21z" id="path-1"/></defs><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="cast" transform="translate(-1.000000, -3.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Combined-Shape" fill="#000" fill-rule="nonzero" xlink:href="#path-1"/></g></g></svg></a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
DCompute:ネイティブDによるOpenCLやCUDAのGPGPU【翻訳】</h2><p><time>2018-03-07</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a> <a href=/tags/translation>#translation</a> <a href=/tags/d_blog>#d_blog</a></p><div style="border:.5em solid gold;padding:1em;margin-bottom:1em"><p style=font-weight:700;margin:0>これは1年以上前の記事です</p><p style=margin:0>ここに書かれている情報、見解は現在のものとは異なっている場合があります。</p></div><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#イントロダクション>イントロダクション</a></li><li><a href=#dcomputeの現状>DComputeの現状</a></li><li><a href=#コード例>コード例</a></li></ul></li></ul></li></ul></nav></aside></header><article><p>この記事は、
<a href=https://dlang.org/blog/2017/07/17/dcompute-gpgpu-with-native-d-for-opencl-and-cuda/>DCompute: GPGPU with Native D for OpenCL and CUDA – The D Blog</a>
を自分用に翻訳したものを
<a href=http://dlang.org/blog/2017/06/16/life-in-the-fast-lane/#comment-1631>許可を得て</a>
公開するものである。</p><p>ソース中にコメントの形で原文を残している。
誤字や誤訳などを見つけたら今すぐ
<a href=https://github.com/kotet/blog.kotet.jp>Pull request</a>だ!</p><hr><p>Nicholas WilsonはMurdoch Universityの生徒です。
BEng (Hons)/BScのためにIndustrial Computer Systems (Hons)とInstrumentation &amp; Control/ Molecular Biology &amp; Genetics and Biomedical Scienceを学んでいます。
彼は電界発光イメージングによるソーラーセルの欠陥のローコストな検出についての卒業論文を書き終わったので、
DComputeの作業をしてそれについてD Blogに書く時間ができました。
彼はピアノとアイススケートをたしなみ、number bashing、オートマトン、その他様々なことをDでできるように7年をかけています。</p><hr><p><img src=/assets/2018/03/ldc.png align=left alt=ldc></p><p>DComputeはGPUやその他アクセラレータを使う計算集約型コードのためにOpenCLやCUDA用のネイティブカーネルをDで書くことをサポートするフレームワークでありコンパイラ拡張です。
ハイパフォーマンスDライブラリやアプリケーションの高速な開発を可能にすることを目標にユーザーコードと退屈なものとエラーを起こしがちなコンピュートAPIとの相互作用を自動化するドライバが開発中です。</p><h3 id=イントロダクション>イントロダクション</h3><p>昨年5月にOpenCL APIの使用をちょっとひどいものにするDのメタプログラミングを行いながら<a href=http://dconf.org/2016/talks/colvin.html>John ColvinのDConf 2016でのプレゼンテーション</a>を見たあと、私は思いました。
「Dでカーネルを書けるようになれば、これはOpenCL Cで文字列操作をするよりもっと簡単になるんじゃないか」
当時は比較的忙しい学期の終わりが来ており、これはいい冬<sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup>のプロジェクトになると思いました。
なんといっても<a href=https://github.com/ldc-developers/ldc>LDC</a>、LLVM D コンパイラはLLVMの<a href=https://github.com/thewilsonator/llvm-target-spirv>SPIR-V</a>とPTXバックエンドへのアクセスができるので、私は「これは難しくない、ただのグルーコードだ」と考えました。
私は<strong>少しばかり</strong>これにかかる時間を甘く見ており、<a href=http://github.com/libmir/dcompute>DCompute</a>(ものに名前をつけるのは難しいことです)の最初のステージ、LDCへの私の変更のメインライニングができたのは2月、つまり8ヶ月後になりました。ちょうどDConfの登録締切の時期で、私はそこで作ったものの進捗について<a href=http://dconf.org/2017/talks/wilson.html>話しました</a>。</p><p>LDCとDMDのフロントエンドコードベースと親しくなること以外にも、(関数がカーネルであると伝えるなどのための)特殊なメタデータやOpenCL Cの<code>__global</code>等やCUDAの<code>__global__</code>等を表現するためのアドレススペースを扱い、LDCにその概念を導入する必要があるため、ターゲットとするLLVM SPIR-VとPTXバックエンドも理解する必要がありました。</p><p>しかし一度コードに親しくなり上記の差異を整理すれば、OpenCLとCUDAの修飾子をコンパイラが認識できる属性に翻訳し命令を簡単で一貫性のあるインターフェースにラッピングする作業は順調に進みました。</p><p>作業が進みほとんどLDCのメインラインにマージする準備が整った頃、私はCIにおける問題にぶつかりました。
Khronosで開発されたSPIR-Vバックエンドはとても古いLLVM 3.6.1をベースにしており、私の思いつきにかかわらず、リリースがありませんでした。
そこで私はバックエンドとコンバージョンユーティリティをLLVMのmasterブランチに向けてフォワードポートし自分で<a href=https://github.com/thewilsonator/llvm/releases>リリース</a>しました。
これは進行中であり、magic intrinsicsの適切なLLVM命令への変換や、LLVM Trunkへバックエンドをマージするための準備のためのTableGen-drivenアプローチへの移行が進んでいます。
うまく行けばすぐに終わるはずです™。</p><h3 id=dcomputeの現状>DComputeの現状</h3><p>現在のDComputeではカーネルをネイティブにDで書くことができ、<a href=https://tour.dlang.org/tour/ja/basics/templates>テンプレートと静的イントロスペクション</a>、
<a href=https://tour.dlang.org/tour/ja/gems/uniform-function-call-syntax-ufcs>UFCS</a>、
<a href=https://tour.dlang.org/tour/ja/gems/scope-guards>スコープガード</a>、
<a href=https://tour.dlang.org/tour/ja/gems/range-algorithms>レンジとそのアルゴリズム</a>、
<a href=https://tour.dlang.org/tour/ja/gems/compile-time-function-evaluation-ctfe>CTFE</a>などの言語機能にアクセスできます。
気をつけるべきこととして、ハードウェアとパフォーマンスの観点から関数ポインタ、仮想関数、動的再帰、RTTI、例外、ガベージコレクタの使用はカーネル言語から除外されています。
OpenCL C++と違いカーネル関数をテンプレート化したりオーバーロードやデフォルト値をもたせたりできる点に注目するべきでしょう。
imageとpipeのサポートは進行中です。</p><h3 id=コード例>コード例</h3><p>Dでカーネルを書くには、<code>-mdcompute-targets=&lt;targets&gt;</code>をLDCに渡す必要があります。
<code>&lt;targets&gt;</code>はコンマで区切られたビルドしたいターゲットのリストで、たとえばOpenCL 1.2とCUDA compute capability 3.5の場合、それぞれ(そう、一度に全部書くことができます!)<code>ocl-120,cuda-350</code>と書きます。
たとえば64ビットモードのときは<code>kernels_ocl120_64.spv</code>のように、そのデバイスのためのすべてのコードを含む1つのファイルが各ターゲットごとに得られます。</p><p>Dにおける「ベクトルの加算」カーネルは以下のようになります:</p><pre><code class=language-d>@compute(CompileFor.deviceOnly) module example;
import ldc.dcompute;
import dcompute.std.index;

alias gf = GlobalPointer!float;

@kernel void vadd(gf a, gf b, gf c) 
{
	auto x = GlobalIndex.x;
	a[x] = b[x]+c[x];
}
</code></pre><p><code>@compute</code>属性がついたモジュールは各コマンドラインターゲットに向けてコンパイルされ、<code>@kernel</code>は関数をカーネルにし、<code>GlobalPointer</code>はOpenCLの<code>__global</code>修飾子と等価です。</p><p>カーネルは関数だけに制限されません。
ラムダやテンプレートも動作します:</p><pre><code class=language-d>@kernel void map(alias F)(KernelArgs!F args)
{
    F(args);
}
//以下ホストコード内
AutoBuffer!float x,y,z; // y &amp; z はデータで初期化されています
q.enqueue!(map!((a,b,c) =&gt; a=b+c))(x.length)(x, y, z);
</code></pre><p><code>KernelArgs</code>はホストの型からデバイスの型
(たとえばポインタへのバッファ。またはこの例の場合<a href=https://github.com/libmir/dcompute/blob/master/source/dcompute/std/index.d#L298>AutoIndexed Pointers</a>へのAutoBuffers)
に変換され、ホストやデバイスの種類の違いからカプセル化されています。</p><p>最後の行はカーネルを起動するのに必要な文<code>q.enqueue!kernel(dimensions)(args)</code>で、CUDAの<code>kernel&lt;&lt;&lt;dimensions,queue&gt;&gt;&gt;(args)</code>と近いものです。
カーネル起動のためのライブラリは開発中です。</p><p>上記の式をホストのコードに変換するすべてのマジックがコンパイラにあるCUDAと違い、<code>q.enqueue!func(sizes)(args)</code>はDComputeのドライバライブラリの静的イントロスペクションによって処理されます。
Dにおいてそのようなことができるたった一つの理由は、コンパイラがシンボルに与える修飾名をシンボルの<code>.mangleof</code>プロパティで取得できるからです。
これとDの簡単でパワフルなテンプレートの組み合わせによって、コンピュートAPIを使うことに関する心的オーバーヘッドを著しく減らすことができました。
また、そのライブラリへの実装もシンプルになり、したがって同じふるまいをコンパイラにさせるのに比べて早く実装できました。
CUDAユーザーに向けた部分はまだ十分ではありませんが、OpenCLユーザーにとっては新風となることでしょう
(<a href=http://www.heterogeneouscompute.org/wordpress/wp-content/uploads/2011/06/Chapter2.txt>OpenCLのベクトル加算ホストコード例</a>のステップ7-11を見てみてください)。</p><p>まだDComputeでこのようなことはできませんが、開発は進み、うまく行けばまもなく現実のものになるでしょう。</p><p>最初のインスピレーションについてJohn Colvinに、編集についてMike Parkerに、そしてLDCのフォークにDavid Nadlinger、 Kai Nacke、 Martin Kinke、またスペシャルサンクスとしてLDCコードベースの理解の補助と作業のレビューについてJohan Engelenに謝辞を伝えたいです。</p><p>DComputeの開発を援助したい(または最新情報を受け取りたい)場合、どうぞ自由に<a href=https://gitter.im/libmir/public>libmir Gitter</a>に連絡してください。
同様に、LLVMへ組み込むための<a href=https://github.com/thewilsonator/llvm>SPIR-V</a> <a href=https://github.com/thewilsonator/llvm-target-spirv>バックエンド</a>の開発への参加も受け付けています。</p><div class=footnotes><hr><ol><li id=fn:1>南半球
<a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li></ol></div></article><footer><h2><a href=/tags/dlang>#dlang</a>
DCompute:ネイティブDによるOpenCLやCUDAのGPGPU【翻訳】</h2><p><time>2018-03-07</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a> <a href=/tags/translation>#translation</a> <a href=/tags/d_blog>#d_blog</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>