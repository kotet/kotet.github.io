<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="TL;DR チューリング完全じゃないかもしれない 作ったもの：kotet/mov-programming: MOV is Turing-Complete はじめに かなり前にx86のmov命令はチ"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.02c91f0bdf54d569f6c715f0a345bf32b55cd4d3ac11e0b98fec7ad1e614c151.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#assembly 入門MOVプログラミング 本当にx86のMOVはチューリング完全なのか - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2019/04/mov-programming/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary><meta name=og:title content="#assembly 入門MOVプログラミング 本当にx86のMOVはチューリング完全なのか - Kotet's Personal Blog"><meta name=og:description content="TL;DR チューリング完全じゃないかもしれない 作ったもの：kotet/mov-programming: MOV is Turing-Complete はじめに かなり前にx86のmov命令はチ"><meta name=twitter:image content=https://blog.kotet.jp/img/common/logo.png><meta name=twitter:url content=https://blog.kotet.jp/2019/04/mov-programming/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.55.2"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><span class=text-up>ABOUT</span><a href=/about title=about><svg width="22" height="22" viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="info" transform="translate(-1.000000, -1.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M12 23C5.92486775 23 1 18.0751322 1 12 1 5.92486775 5.92486775 1 12 1 18.0751322 1 23 5.92486775 23 12 23 18.0751322 18.0751322 23 12 23zm0-2C16.9705627 21 21 16.9705627 21 12 21 7.02943725 16.9705627 3 12 3 7.02943725 3 3 7.02943725 3 12 3 16.9705627 7.02943725 21 12 21zM13.0036109 13.9983464H14.0029544v2h-4v-2h1v-2h-1V9.99834639h3.0006565V13.9983464zM12.0003283 8.99834639C11.4478622 8.99834639 11 8.55063114 11 7.99834639 11 7.44606164 11.4478622 6.99834639 12.0003283 6.99834639 12.5527943 6.99834639 13.0006565 7.44606164 13.0006565 7.99834639c0 .5522847500000001-.44786219999999943 1-1.0003282000000002 1z" id="Oval-17" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>DOWNLOAD</span><a href=/products title=download><svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="download" transform="translate(-2.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M22 16v4C22 21.1045695 21.1045695 22 20 22H4C2.8954305 22 2 21.1045695 2 20V16H4v4H20V16h2zm-9-3.4142136L16.2928932 9.29289322 17.7071068 10.7071068 12 16.4142136 6.29289322 10.7071068 7.70710678 9.29289322 11 12.5857864V2h2V12.5857864z" id="Combined-Shape" fill="#000"/></g></g></svg></a></li><li><span class=text-up>TAG</span><a href=/tags title=tag><svg width="22" height="14" viewBox="0 0 22 14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="tag" transform="translate(-1.000000, -5.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M6.53518376 5H21C22.1045695 5 23 5.8954305 23 7V17C23 18.1045695 22.1045695 19 21 19H6.53518376C5.86647738 19 5.24201473 18.6657977 4.87108317 18.1094004L1.16794971 12.5547002C.944016765 12.2188008.944016765 11.7811992 1.16794971 11.4452998L4.87108317 5.89059961C5.24201473 5.33420227 5.86647738 5 6.53518376 5zM3.20185043 12l3.33333333 5H21V7H6.53518376L3.20185043 12zM7 13C6.44771525 13 6 12.5522847 6 12 6 11.4477153 6.44771525 11 7 11 7.55228475 11 8 11.4477153 8 12 8 12.5522847 7.55228475 13 7 13z" id="Rectangle-29" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-bottom>PODCAST</span><a href=https://podcast.kotet.jp title=podcast><svg width="22" height="20" viewBox="0 0 22 20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs/><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="broadcasting" transform="translate(-1.000000, -2.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><path d="M9.38742589 20 8.72075922 22H6.61257411L9.89881747 12.1412699C9.34410225 11.5968755 9 10.8386225 9 10 9 8.34314575 10.3431458 7 12 7 13.6568542 7 15 8.34314575 15 10 15 10.8386225 14.6558977 11.5968755 14.1011825 12.1412699L17.3874259 22H15.2792408L14.6125741 20H9.38742589zM10.7207592 16 10.0540926 18H13.9459074L13.2792408 16H10.7207592zM11.3874259 14H12.6125741L12.2750928 12.987556C12.1844984 12.9957918 12.0927406 13 12 13 11.9072594 13 11.8155016 12.9957918 11.7249072 12.987556L11.3874259 14zM12 11C12.5522847 11 13 10.5522847 13 10 13 9.44771525 12.5522847 9 12 9 11.4477153 9 11 9.44771525 11 10 11 10.5522847 11.4477153 11 12 11zm8.108743-8.43301443C21.9041909 4.52460368 23 7.13433188 23 10 23 12.8656681 21.9041909 15.4753963 20.108743 17.4330144L18.6344261 16.0815573C20.103429 14.4798697 21 12.3446376 21 10 21 7.65536245 20.103429 5.52013028 18.6344261 3.91844274L20.108743 2.56698557zM17.1601092 5.26989991C18.302667 6.51565689 19 8.17639301 19 10 19 11.823607 18.302667 13.4843431 17.1601092 14.7301001L15.6857923 13.3786429C16.501905 12.4888165 17 11.3025764 17 10 17 8.69742358 16.501905 7.51118349 15.6857923 6.62135708L17.1601092 5.26989991zM3.89125699 2.56665655 5.3655739 3.91811372C3.89657104 5.51980126 3 7.65503343 3 9.99967098 3 12.3443085 3.89657104 14.4795407 5.3655739 16.0812282L3.89125699 17.4326854C2.09580905 15.4750673 1 12.8653391 1 9.99967098 1 7.13400286 2.09580905 4.52427466 3.89125699 2.56665655zM6.83989081 5.26957089 8.31420772 6.62102806C7.49809502 7.51085447 7 8.69709456 7 9.99967098 7 11.3022474 7.49809502 12.4884875 8.31420772 13.3783139L6.83989081 14.7297711C5.69733303 13.4840141 5 11.823278 5 9.99967098 5 8.17606399 5.69733303 6.51532787 6.83989081 5.26957089z" id="Combined-Shape" fill="#000" fill-rule="nonzero"/></g></g></svg></a></li><li><span class=text-up>FEED</span><a href=/index.xml title=feed><svg width="22" height="18" viewBox="6 8 .5 10" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><desc>Created with Sketch.</desc><defs><path d="M1 21V19C2.1045695 19 3 19.8954305 3 21H1zm6 0H5C5 18.790861 3.209139 17 1 17V15C4.3137085 15 7 17.6862915 7 21zm4 0H9C9 16.581722 5.418278 13 1 13V11C6.5228475 11 11 15.4771525 11 21z" id="path-1"/></defs><g id="export" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="cast" transform="translate(-1.000000, -3.000000)"><path id="placeholder" fill-opacity="0" fill="#fff" d="M0 0h24v24H0z"/><mask id="mask-2" fill="#fff"><use xlink:href="#path-1"/></mask><use id="Combined-Shape" fill="#000" fill-rule="nonzero" xlink:href="#path-1"/></g></g></svg></a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/assembly>#assembly</a>
入門MOVプログラミング 本当にx86のMOVはチューリング完全なのか</h2><p><time>2019-04-18</time>
<a href=/tags/assembly>#assembly</a> <a href=/tags/tech>#tech</a></p><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#tl-dr>TL;DR</a></li><li><a href=#はじめに>はじめに</a></li><li><a href=#同値比較>同値比較</a></li><li><a href=#三項演算子>三項演算子</a></li><li><a href=#論理積>論理積</a></li><li><a href=#論理回路>論理回路</a></li><li><a href=#条件分岐>条件分岐</a></li><li><a href=#ループ-無理>ループ（無理）</a></li><li><a href=#おわり>おわり</a></li></ul></li></ul></li></ul></nav></aside></header><article><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/x86asm.min.js></script><h3 id=tl-dr>TL;DR</h3><p>チューリング完全じゃないかもしれない</p><p>作ったもの：<a href=https://github.com/kotet/mov-programming>kotet/mov-programming: MOV is Turing-Complete</a></p><h3 id=はじめに>はじめに</h3><p>かなり前にx86の<code>mov</code>命令はチューリング完全であるという記事を読みました。
その当時はアセンブリ（と英語）が読めなかったため、仕組みはわからないけどすごいなあと読み流していました。</p><p>ふとその話を思い出したので、今回は元となった論文<sup class=footnote-ref id=fnref:1><a href=#fn:1>1</a></sup>を読んで実際に簡単な計算をしてみようと思います。</p><h3 id=同値比較>同値比較</h3><p><code>mov</code>命令は指定した場所へデータをコピーする命令です。
コピーするデータやコピー先は様々な方法で指定できます。</p><p>x86_64の<code>mov</code>命令はかなり自由度が高く、組み合わせることで計算が行えてしまいます。</p><p>まず<code>mov</code>で同値比較を行います。
Cで同じようなことをすると以下のようになります。</p><pre><code class=language-c>int equal(char a, char b)
{
    char buf[256];
    buf[a] = 0;
    buf[b] = 1;
    return buf[a];
}
</code></pre><p><code>a</code>と<code>b</code>が同じ値なら<code>buf[a] = 0;</code>で入れた<code>0</code>は<code>buf[b] = 1;</code>で上書きされます。
最終的にこれは<code>a</code>と<code>b</code>が同じなら<code>1</code>を、異なるなら<code>0</code>を返します。</p><p>これをアセンブリで書きます。
<code>mov</code>命令は書き込み先にメモリを指定できます。
ごく単純に書くと以下のようになります。
レジスタ<code>a</code>が指すメモリ領域に結果が入っています。</p><pre><code class=language-x86asm>mov [a] 0
mov [b] 1
</code></pre><p>しかし<code>a</code>や<code>b</code>に入っている値(<code>0</code>~<code>255</code>)は操作が許可されていないアドレスのことが多いので、
このままでは実際に動かせるプログラムにはなりません。</p><p>しかしx86の<code>mov</code>命令はある程度の計算ができます。
アドレスを指定するとき、<code>ベースレジスタ + インデックスレジスタ * 定数 + 定数</code>といった形でアドレスを計算して指定することができます。</p><p>これをCから呼び出せるちゃんとしたアセンブリにするとこんな感じになります。
最初と最後にCと接続して使うためのコードがあるのを除けば<code>mov</code>だけで書かれています。</p><pre><code class=language-x86asm>.intel_syntax noprefix
.global equal
equal:
    push rbp
    mov rbp, rsp
    sub rsp, 256

    mov BYTE PTR [rbp + rdi - 256], 0
    mov BYTE PTR [rbp + rsi - 256], 1

    mov al, BYTE PTR [rbp + rdi - 256]
    movzb rax, al

    mov rsp, rbp
    pop rbp
    ret
</code></pre><p>第一引数の値は<code>rdi</code>に、第二引数の値は<code>rsi</code>に入っています。</p><pre><code class=language-c>#include &lt;stdio.h&gt;
int equal(char a, char b);

int main(void)
{
    printf(&quot;equal(2,3) = %d\n&quot;, equal(2,3));
    printf(&quot;equal(3,3) = %d\n&quot;, equal(3,3));
}
</code></pre><pre><code class=language-console>$ gcc -static -o movprog main.c equal.s
$ ./movprog
equal(2,3) = 0
equal(3,3) = 1
</code></pre><p>これは入力に<code>0</code>か<code>1</code>しか渡さないようにすれば<a href=https://ja.wikipedia.org/wiki/%E5%90%8C%E5%80%A4>xnor</a>です。</p><h3 id=三項演算子>三項演算子</h3><p>この後出てくる論理積や条件分岐では<a href=https://ja.wikipedia.org/wiki/%E6%9D%A1%E4%BB%B6%E6%BC%94%E7%AE%97%E5%AD%90>三項演算子</a>的処理を行っています。
Cで書いてみます。</p><pre><code class=language-c>// (b) ? x : y;
int ternary(int b, char x, char y)
{
    char buf[2];
    buf[0] = y;
    buf[1] = x;
    return buf[b];
}
</code></pre><p><code>0</code>または<code>1</code>である<code>b</code>の値をインデックスにして<code>x</code>と<code>y</code>の値を選びます。
アセンブリで単純化して書くと以下のようになります。</p><pre><code class=language-x86asm>mov [buf + 0], y
mov [buf + 1], x
mov rax, [buf + b]
</code></pre><p>これを使って<code>0</code>、<code>1</code>や定数を超えて自由に数値を入れることができるようになります。</p><h3 id=論理積>論理積</h3><p>上のテクニックを使うと論理積も<code>mov</code>だけで実現できます。
Cで書くとこのようになります。</p><pre><code class=language-c>int and(char a, char b)
{
    char buf[2];
    buf[0] = 0;
    buf[1] = b;
    return buf[a];
}
</code></pre><p>アセンブリにすると以下のようになります。</p><pre><code class=language-x86asm>.intel_syntax noprefix
.global and
and:
    push rbp
    mov rbp,rsp
    sub rsp, 2

    mov BYTE PTR [rbp - 2], 0
    mov BYTE PTR [rbp - 1], dil
    mov al, BYTE PTR [rbp + rsi - 2]
    movzb rax, al

    mov rsp, rbp
    pop rbp
    ret
</code></pre><p>こちらもちゃんと論理積として動いていることがわかります。</p><pre><code class=language-c>int and(char a, char b);

int main(void)
{
    printf(&quot;and(0,0) = %d\n&quot;, and(0,0));
    printf(&quot;and(0,1) = %d\n&quot;, and(0,1));
    printf(&quot;and(1,0) = %d\n&quot;, and(1,0));
    printf(&quot;and(1,1) = %d\n&quot;, and(1,0));
}
</code></pre><pre><code class=language-console>$ gcc -static -o movprog main.c and.s
$ ./movprog
and(0,0) = 0
and(0,1) = 0
and(1,0) = 0
and(1,1) = 1
</code></pre><p>これと同じ発想で論理和も作ることができます。</p><h3 id=論理回路>論理回路</h3><p>上でxnorとand(or)が作れたので、それを組み合わせて好きな論理回路が作れます。</p><p>たとえば半加算器を書いてみました。</p><pre><code class=language-x86asm>.intel_syntax noprefix
.global halfadder
halfadder:
    push rbp
    mov rbp,rsp
    sub rsp, 256

    mov BYTE PTR [rbp + rdi - 256], 0
    mov BYTE PTR [rbp + rsi - 256], 1
    mov al, BYTE PTR [rbp + rdi - 256]
    movzb rax, al

    mov BYTE PTR [rbp + rax - 256], 0
    mov BYTE PTR [rbp - 256], 1
    mov al, BYTE PTR [rbp + rax - 256]
    movzb rax, al

    mov BYTE PTR [rbp - 2], 0
    mov BYTE PTR [rbp - 1], dil
    mov dil, BYTE PTR [rbp + rsi - 2]
    mov BYTE PTR [rdx], dil

    mov rsp, rbp
    pop rbp
    ret
</code></pre><pre><code class=language-c>#include &lt;stdio.h&gt;

int halfadder(char a, char b, char *dst);

int main(void)
{
    for (int i = 0; i &lt; 2; i++)
        for (int j = 0; j &lt; 2; j++)
        {
            char c;
            char s = halfadder(i, j, &amp;c);
            printf(&quot;halfadder(%d,%d) = %d %d\n&quot;, i, j, c, s);
        }
}
</code></pre><pre><code class=language-console>$ gcc -static -o movprog main.c halfadder.s
$ ./movprog
halfadder(0,0) = 0 0
halfadder(0,1) = 0 1
halfadder(1,0) = 0 1
halfadder(1,1) = 1 0
</code></pre><p>全加算器は途中でややこしくなって諦めました。
数十行に渡って並んだ<code>mov</code>命令のデバッグとかできるわけないだろ！</p><h3 id=条件分岐>条件分岐</h3><p>分岐命令が使えないので、書かれた<code>mov</code>命令は上から順にすべて実行されます。
しかし操作するアドレスをダミーに入れ替えることで命令の無力化はできます。</p><p>三項演算子を使うと参照するアドレスを論理演算の結果で切り替えることができます。</p><pre><code>... 前略 ...

&lt;ベースレジスタ&gt; = &lt;論理演算の結果&gt; ? &lt;普通のアドレス&gt; : &lt;どこか遠いところ&gt;

    ... if文の中身 ...

&lt;ベースレジスタ&gt; = &lt;普通のアドレス&gt;

... 後略 ...
</code></pre><p>論理演算の結果が偽のときは実行結果に影響しないどこか遠いところで<code>mov</code>命令を動かします。
遠いところなので実質何も起きていないのと同じです。</p><p>実行時間が条件分岐で変化しないのでセキュリティ的に良いかもしれませんね！</p><h3 id=ループ-無理>ループ（無理）</h3><p>こうしてできたコードを終了まで繰り返す方法があればだいたいなんでも書けるようになります。
しかし前の条件分岐で見たように<code>mov</code>命令は上から下に実行される以外の能力がありません。
<a href=https://toshiba.semicon-storage.com/jp/design-support/e-learning/micro_intro/chap4/1274772.html>プログラムカウンタ</a>を
<code>mov</code>命令で書き換えられればループになりますが、残念ながらそういうことはできません。
チューリングマシンを実現するために一体どんな方法でループを実現しているのでしょうか……？</p><p>実は元論文ではコードの最後に無条件ジャンプを1つだけ使い、プログラムの最初に戻っています。
<strong>ズルじゃん！movだけじゃないじゃん！</strong></p><h3 id=おわり>おわり</h3><p>というわけで元論文では最後に<code>jmp</code>命令をひとつだけ使ってチューリングマシンを作っていました。
どうやら環状リンクリストを作ってテープとして使うようです。
全部<code>mov</code>だけで解決しているものだと思っていたのでガッカリしました。</p><p>しかし<code>mov</code>だけで自由に論理回路が組めるのは事実です。
手書きするにはなかなかつらいものがありますが、縛りプレイ、頭の体操としてやってみると楽しいです。
ぜひやってみてください。</p><div class=footnotes><hr><ol><li id=fn:1><a href=http://stedolan.net/research/mov.pdf>Stephen Dolan. MOV is Turing-complete. Computer Laboratory, University of Cambridge, 2013.</a>
<a class=footnote-return href=#fnref:1><sup>[return]</sup></a></li></ol></div></article><footer><h2><a href=/tags/assembly>#assembly</a>
入門MOVプログラミング 本当にx86のMOVはチューリング完全なのか</h2><p><time>2019-04-18</time>
<a href=/tags/assembly>#assembly</a> <a href=/tags/tech>#tech</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>