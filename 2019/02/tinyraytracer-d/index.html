<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content="レイトレーシングという3Dレンダリング手法があります。 レイ トレーシング（ray tracing, 光線追跡法）は、光線などを追跡することで、ある点において観測"><link rel=stylesheet href=https://blog.kotet.jp/sass/single.min.a46209b7292a5337cb1ba441dd38238fbe3cc498d46e0bd08c757deccdc8f28f.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/d.min.js></script><script>hljs.configure({languages:[]})
hljs.initHighlightingOnLoad();</script><script defer src="//cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type=text/javascript></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$']],
        processEscapes: true
      }
    });
</script><title>#dlang ライブラリ不使用、数百行でレイトレーサを書いて新世界の神になる - Kotet&#39;s Personal Blog</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://blog.kotet.jp/2019/02/tinyraytracer-d/><link rel=icon href=/favicon.ico><meta name=twitter:card content=summary_large_image><meta name=og:title content="#dlang ライブラリ不使用、数百行でレイトレーサを書いて新世界の神になる - Kotet's Personal Blog"><meta name=og:description content="レイトレーシングという3Dレンダリング手法があります。 レイ トレーシング（ray tracing, 光線追跡法）は、光線などを追跡することで、ある点において観測"><meta name=og:image content=https://blog.kotet.jp/img/blog/2019/02/raytracer.jpg><meta name=twitter:url content=https://blog.kotet.jp/2019/02/tinyraytracer-d/><meta name=twitter:site content=@kotetttt><meta name=twitter:creator content=@kotetttt><meta name=generator content="Hugo 0.54.0"><script defer src="//www.googletagmanager.com/gtag/js?id=UA-88180620-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-88180620-1');</script><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8443812672116269",enable_page_level_ads:true});</script></head><body><header class=site><nav><ul><li><a href=/about>ABOUT</a></li><li><a href=/products>PRODUCTS</a></li><li><a href=/tags>TAGS</a></li><li><a href=/index.xml>FEED</a></li></ul></nav><h1><a href=/>KOTET'S<br>PERSONAL<br>BLOG</a></h1></header><main><header><h2><a href=/tags/dlang>#dlang</a>
ライブラリ不使用、数百行でレイトレーサを書いて新世界の神になる</h2><p><time>2019-02-08</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p><aside><p>Table of Contents</p><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#tinyraytracer>tinyraytracer</a></li><li><a href=#球との衝突判定>球との衝突判定</a></li><li><a href=#スクリーン座標からの変換>スクリーン座標からの変換</a></li><li><a href=#反射>反射</a></li><li><a href=#屈折>屈折</a></li></ul></li></ul></li></ul></nav></aside></header><article><p>レイトレーシングという3Dレンダリング手法があります。</p><blockquote><p>レイ トレーシング（ray tracing, 光線追跡法）は、光線などを追跡することで、ある点において観測される像などをシミュレートする手法である。</p><p><a href=https://ja.wikipedia.org/wiki/%E3%83%AC%E3%82%A4%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%B3%E3%82%B0>レイトレーシング - Wikipedia</a></p></blockquote><p>あるていど物理法則をシミュレートしていて、
その結果それなりにリアルな画像が出てくるというのが仮想的な世界を作っている感じでテンション上がりますよね。
というわけでいつか作ってみたいと思っていました。</p><h3 id=tinyraytracer>tinyraytracer</h3><p>256行のC++でレイトレーサを書くという学習用リポジトリがあります。
標準ライブラリの機能のみを使いppm形式の画像を出力するレイトレーサを書いています。</p><p><a href=https://github.com/ssloy/tinyraytracer>ssloy/tinyraytracer: A brief computer graphics / rendering course</a></p><p>それをもとにDで新世界の神になりました。
こんな感じの画像が出てきます。</p><p><img src=/img/blog/2019/02/raytracer.jpg alt></p><p><a href=https://github.com/kotet/tinyraytracer-d>kotet/tinyraytracer-d: https://github.com/ssloy/tinyraytracer</a></p><p>300行以上に行数が増えてしまっているように見えます。
しかし実は元のtinyraytracerには<code>geometry.h</code>というヘッダファイルがあり、
そこで<code>vec3f</code>等のデータ構造が80行以上かけて実装されているのでこちらも厳密には256行ではありません。
なのでセーフです。
セーフです。</p><p>この記事はtinyraytracerのコードと
<a href=https://github.com/ssloy/tinyraytracer/wiki>Wiki</a>
をパッと読んだだけではわからなかったところを補足する計算ノートです。</p><h3 id=球との衝突判定>球との衝突判定</h3><pre><code class=language-cpp>bool ray_intersect(const Vec3f &amp;orig, const Vec3f &amp;dir, float &amp;t0) const {
        Vec3f L = center - orig;
        float tca = L*dir;
        float d2 = L*L - tca*tca;
        if (d2 &gt; radius*radius) return false;
        float thc = sqrtf(radius*radius - d2);
        t0       = tca - thc;
        float t1 = tca + thc;
        if (t0 &lt; 0) t0 = t1;
        if (t0 &lt; 0) return false;
        return true;
    }
</code></pre><p><code>t0</code>にはレイの起点から衝突地点までの距離が入ります。</p><p><img src=/img/blog/2019/02/raytracer-fig1.png alt></p><hr><p>$\vec{L}$と$\vec{dir}$の角度を$\theta$と置く。</p><p>$$ tca = \vec{L} \cdot \vec{dir} = |\vec{L}|\cos{\theta} $$</p><p>$$
\begin{align}
d_2 &amp;= \vec{L} \cdot \vec{L} - tca^2 \\<br>&amp;= |\vec{L}|^2 - |\vec{L}|^2\cos^2{\theta} \\<br>&amp;= |\vec{L}|^2(1 - \cos^2{\theta}) \\<br>&amp;= (|\vec{L}|\sin{\theta})^2
\end{align}
$$</p><hr><p><img src=/img/blog/2019/02/raytracer-fig2.png alt></p><hr><p>$$ thc = \sqrt{radius^2 - d_2^2} $$</p><hr><h3 id=スクリーン座標からの変換>スクリーン座標からの変換</h3><pre><code class=language-cpp>#pragma omp parallel for
for (size_t j = 0; j&lt;height; j++) {
    for (size_t i = 0; i&lt;width; i++) {
        float x =  (2*(i + 0.5)/(float)width  - 1)*tan(fov/2.)*width/(float)height;
        float y = -(2*(j + 0.5)/(float)height - 1)*tan(fov/2.);
        Vec3f dir = Vec3f(x, y, -1).normalize();
        framebuffer[i+j*width] = cast_ray(Vec3f(0,0,0), dir, sphere);
    }
}
</code></pre><hr><p>$$ \frac{1}{width} - 1 \lt \frac{2(i+0.5)}{width} - 1 \lt 1 - \frac{1}{width} $$
$$ (0 \leq i \lt width) $$</p><hr><p><img src=/img/blog/2019/02/raytracer-fig3.png alt></p><h3 id=反射>反射</h3><pre><code class=language-cpp>Vec3f reflect(const Vec3f &amp;I, const Vec3f &amp;N) {
    return I - N*2.f*(I*N);
}
</code></pre><p><img src=/img/blog/2019/02/raytracer-fig4.png alt></p><hr><p>$$ I \cdot N = -\cos{\theta} $$</p><hr><h3 id=屈折>屈折</h3><pre><code class=language-cpp>Vec3f refract(const Vec3f &amp;I, const Vec3f &amp;N, const float &amp;refractive_index) { // Snell's law
    float cosi = - std::max(-1.f, std::min(1.f, I*N));
    float etai = 1, etat = refractive_index;
    Vec3f n = N;
    if (cosi &lt; 0) { // if the ray is inside the object, swap the indices and invert the normal to get the correct result
        cosi = -cosi;
        std::swap(etai, etat); n = -N;
    }
    float eta = etai / etat;
    float k = 1 - eta*eta*(1 - cosi*cosi);
    return k &lt; 0 ? Vec3f(0,0,0) : I*eta + n*(eta * cosi - sqrtf(k));
}
</code></pre><p><img src=/img/blog/2019/02/raytracer-fig5.png alt></p><hr><p>参考: <a href=https://t-pot.com/program/96_RayTraceReflect/index.html>t-pot『Ray Tracing : Reflection &amp; Refraction』</a></p><p>屈折光の向きを表す単位ベクトルを$\vec{T}$、水平方向の単位ベクトルを$\vec{e}$とおく。</p><p>$$ \vec{T} = -\vec{N} \cos{t} + \vec{e} \sin{t} $$
$$ cosi = -(\vec{I} \cdot \vec{N}) $$</p><p>$\vec{e}\sin{i} = \vec{N}\cos{i} + \vec{I} = cosi\vec{N} + \vec{I}$より</p><p>$$
\begin{align}
\vec{T} &amp;= -\vec{N} \cos{t} + \frac{cosi\vec{N} + \vec{I}}{\sin{i}} \sin{t} \\<br>&amp;= -\vec{N} \cos{t} + \frac{\sin{t}}{\sin{i}} (cosi\vec{N} + \vec{I})
\end{align}
$$</p><p>スネルの法則 $\frac{\sin{t}}{\sin{i}} = \frac{etai}{etat} = eta$ より</p><p>$$
\begin{align}
\vec{T} &amp;= -\vec{N} \cos{t} + eta (cosi\vec{N} + \vec{I}) \\<br>&amp;= -\vec{N} \sqrt{1 - \sin^2{t}} + eta (cosi\vec{N} + \vec{I}) \\<br>&amp;= -\vec{N} \sqrt{1 - eta^2 \sin^2{i}} + eta (cosi\vec{N} + \vec{I}) \\<br>&amp;= -\vec{N} \sqrt{1 - eta^2 (1-cosi^2)} + eta (cosi\vec{N} + \vec{I}) \\<br>&amp;= -\vec{N} \sqrt{k} + eta (cosi\vec{N} + \vec{I}) \\<br>&amp;= \vec{I} \times eta + \vec{N}(eta \times cosi - \sqrt{k}) \\<br>\end{align}
$$</p></article><footer><h2><a href=/tags/dlang>#dlang</a>
ライブラリ不使用、数百行でレイトレーサを書いて新世界の神になる</h2><p><time>2019-02-08</time>
<a href=/tags/dlang>#dlang</a> <a href=/tags/tech>#tech</a></p></footer><div class=ad-wrapper><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-8443812672116269 data-ad-slot=2914874272 data-ad-format=horizontal data-full-width-responsive=true></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script></div></main><footer class=site></footer></body></html>